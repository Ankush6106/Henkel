{% extends "base.html" %} {% block title %}Material Cost{% endblock %} {% block
content %}

<div class="d-flex gap-2 mb-4">
  <button class="btn btn-danger" onclick="toggleQuotationForm()">
    Quotation
  </button>

  <button
    class="btn btn-outline-danger"
    onclick="togglePartSpecificationForm()"
    {%
    if
    not
    quotation_id
    %}disabled{%
    endif
    %}
  >
    Part Specification
  </button>

  <button
    class="btn btn-outline-secondary"
    {%
    if
    not
    positions
    %}disabled{%
    endif
    %}
  >
    Costing
  </button>
</div>

{% if not quotation_id %}
<small class="text-muted"> Save quotation to enable Part Specification </small>
{% endif %}

<!-- Toggle Button -->
{% if not quotation_id %}
<h4 class="text-danger mb-3">Quotation Details</h4>
<button class="btn btn-outline-danger mb-3" onclick="toggleQuotationForm()">
  + Add Quotation
</button>
{% endif %}

<!-- Quotation Form Card -->
<div id="quotationFormCard" class="card shadow-sm d-none">
  <div class="card-body">
    <form method="POST" action="/save_quotation">
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Internal Project</label>
          <input
            type="text"
            name="internal_Project"
            class="form-control"
            required
          />
        </div>

        <div class="col-md-6">
          <label class="form-label">Vehicle Code</label>
          <input type="text" name="vehicle_code" class="form-control" />
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">OEM SOP</label>
          <input type="text" name="OEM_SOP" class="form-control" />
        </div>

        <div class="col-md-6">
          <label class="form-label">Henkel PL</label>
          <input type="text" name="henkel_PL" class="form-control" />
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Quotation Date</label>
          <input type="date" name="quotation_date" class="form-control" />
        </div>

        <div class="col-md-6">
          <label class="form-label">Quotation Revision Level</label>
          <input
            type="number"
            name="quotation_rev_level"
            class="form-control"
          />
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Supplier</label>
          <input type="text" name="supplier" class="form-control" />
        </div>

        <div class="col-md-6">
          <label class="form-label">Supplier Contact</label>
          <input
            type="text"
            name="supplier_contact"
            class="form-control"
            maxlength="15"
          />
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">LCUR for Quotation</label>
          <input type="text" name="LCUR_for_quotation" class="form-control" />
        </div>

        <div class="col-md-6">
          <label class="form-label">LCUR Abbreviation</label>
          <input type="text" name="LCUR_abbreviation" class="form-control" />
        </div>
      </div>

      <div class="text-end">
        <button type="submit" class="btn btn-danger">Save Quotation</button>
      </div>
    </form>
  </div>
</div>

<!--Part specifications form-->
<!-- Toggle Button -->
{% if quotation_id %}
<h4 class="text-danger mb-3">Part specifications</h4>

<button
  type="button"
  class="btn btn-outline-danger mb-3"
  onclick="togglePartSpecificationForm()"
>
  + Part specifications
</button>
{% endif %}

<div id="partSpecificationFormCard" class="card shadow-sm d-none">
  <div class="card-body">
    <h5 class="text-danger">Generate Positions</h5>
    {% if quotation_id %}
    <form method="POST" action="/generate_positions/{{ quotation_id }}">
      <label>No. of Positions</label>
      <input type="number" name="pos_count" min="1" max="100" required />
      <button class="btn btn-sm btn-danger">Generate</button>
    </form>
    {% endif %}

    <form method="POST" action="/save_section_1/{{ quotation_id }}">
      <div class="table-responsive table-scroll">
        <table class="table table-bordered align-middle mt-4">
          <thead class="table-light text-center">
            <tr>
              <th>POS Nr.</th>
              {% for pos in positions %}
              <th>Pos.{{ pos.pos_no }}</th>
              {% endfor %}
            </tr>
          </thead>

          <tbody>
            <tr class="table-primary section-main">
              <td colspan="{{ positions|length + 1 }}">
                <strong>1.1 Project Details per Part</strong>
              </td>
            </tr>

            <tr class="table-secondary section-sub">
              <td colspan="{{ positions|length + 1 }}">
                <strong>Part Identification</strong>
              </td>
            </tr>

            <tr>
              <td>Section</td>
              {% for pos in positions %}
              <td>
                <input name="section[{{ pos.id }}]" class="form-control" />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Design for offer</td>
              {% for pos in positions %}
              <td>
                <input
                  name="design_for_offer[{{ pos.id }}]"
                  class="form-control"
                />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Customer Part Number</td>
              {% for pos in positions %}
              <td>
                <input
                  name="customer_part_number[{{ pos.id }}]"
                  class="form-control"
                />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Customer Part Name</td>
              {% for pos in positions %}
              <td>
                <input
                  name="customer_part_name[{{ pos.id }}]"
                  class="form-control"
                />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Henkel IDH Number</td>
              {% for pos in positions %}
              <td>
                <input name="idh_number[{{ pos.id }}]" class="form-control" />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>IMDS Number</td>
              {% for pos in positions %}
              <td>
                <input
                  type="text"
                  name="imds_number[{{ pos.id }}]"
                  class="form-control"
                />
              </td>
              {% endfor %}
            </tr>
            <!--======================-->
            <tr class="table-secondary">
              <td colspan="{{ positions|length + 1 }}">
                <strong>Design & Concept</strong>
              </td>
            </tr>
            <tr>
              <td>Henkel PN / Design level</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  name="design_level[{{ pos.id }}]"
                  class="form-control"
                />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Part concept</td>
              {% for pos in positions %}
              <td>
                <select name="part_concept[{{ pos.id }}]" class="form-control">
                  <option value="">-- Select --</option>
                  {% for pc in part_concepts %}
                  <option value="{{ pc.id }}">{{ pc.partConceptName }}</option>
                  {% endfor %}
                </select>
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Design Concept</td>
              {% for pos in positions %}
              <td>
                <select
                  name="design_concept[{{ pos.id }}]"
                  class="form-control"
                >
                  <option value="">-- Select --</option>
                  {% for dc in design_concepts %}
                  <option value="{{ dc.id }}">
                    {{ dc.designConceptName }}
                  </option>
                  {% endfor %}
                </select>
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Clip Design</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  name="clip_design[{{ pos.id }}]"
                  class="form-control"
                />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Number of Clips</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  name="number_of_clips[{{ pos.id }}]"
                  class="form-control"
                />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Gap to the panel</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  name="gap_to_panel[{{ pos.id }}]"
                  class="form-control"
                />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Design Features</td>
              {% for pos in positions %}
              <td>
                <input
                  type="text"
                  name="design_features[{{ pos.id }}]"
                  class="form-control"
                />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Life time (years)</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  name="lifetime_years[{{ pos.id }}]"
                  class="form-control"
                />
              </td>
              {% endfor %}
            </tr>
            <!--=========================-->
            <tr class="table-secondary">
              <td colspan="{{ positions|length + 1 }}">
                <strong>Production Volume – Plant / Car / Derivatives</strong>
              </td>
            </tr>
            <!--pos_plant_derivatives-->
            {% for d in range(1, 9) %}
            <tr>
              <td>Plant / Car / Derivat {{ d }} [(avg.) cars/a]</td>

              {% for pos in positions %}
              <td class="text-center">
                <div class="d-flex gap-2 align-items-center">
                  <input
                    type="checkbox"
                    class="form-check-input derivative-check"
                    data-pos="{{ pos.id }}"
                    data-derivative="{{ d }}"
                    name="derivative_selected[{{ pos.id }}][{{ d }}]"
                    onchange="this.nextElementSibling.disabled = !this.checked;calculatePlantTotals();"
                  />

                  <input
                    type="number"
                    class="form-control plant-input"
                    name="derivative_value[{{ pos.id }}][{{ d }}]"
                    data-pos="{{ pos.id }}"
                    data-derivative="{{ d }}"
                    value="0"
                    min="0"
                    disabled
                    oninput="calculatePlantTotals()"
                  />
                </div>
              </td>
              {% endfor %}
            </tr>
            {% endfor %}
            <tr>
              <td><strong>Total (avg.) cars / a</strong></td>

              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control plant-total"
                  id="plant_total_{{ pos.id }}"
                  data-pos="{{ pos.id }}"
                  value="0"
                  readonly
                />
              </td>
              {% endfor %}
            </tr>
            <!--pos_plant_derivatives-->
            <!--=========================-->
            <tr class="table-secondary">
              <td colspan="{{ positions|length + 1 }}">
                <strong>Annual Quantities</strong>
              </td>
            </tr>
            <tr>
              <td>Parts / Car</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  name="parts_per_car[{{ pos.id }}]"
                  class="form-control parts-per-car"
                  data-pos="{{ pos.id }}"
                />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Parts / Year (+/- 30%)</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  name="parts_per_year[{{ pos.id }}]"
                  class="form-control parts-per-year"
                  data-pos="{{ pos.id }}"
                  readonly
                />
              </td>
              {% endfor %}
            </tr>
            <tr class="table-secondary">
              <td colspan="{{ positions|length + 1 }}">
                <strong>Comments</strong>
              </td>
            </tr>

            <tr>
              <td>Comments</td>
              {% for pos in positions %}
              <td>
                <textarea
                  name="comments[{{ pos.id }}]"
                  class="form-control"
                ></textarea>
              </td>
              {% endfor %}
            </tr>

            <tr class="table-primary section-main">
              <td colspan="{{ positions|length + 1 }}">
                <strong>1.2 Weight per Part</strong>
              </td>
            </tr>

            <tr class="table-secondary section-sub">
              <td colspan="{{ positions|length + 1 }}">
                <strong>Material A</strong>
              </td>
            </tr>

            <!--Material A-(Carrier)-->
            <tr>
              <td>Material A-(Carrier)</td>
              {% for pos in positions %}
              <td>
                <select
                  name="material_a[{{ pos.id }}]"
                  class="form-control material-select"
                  data-type="a"
                  data-pos="{{ pos.id }}"
                >
                  <option value="">-- Select Material --</option>
                  {% for m in materials_a %}
                  <option
                    value="{{ m.Material_A }}"
                    data-density="{{ m.Density_kg_dm3 }}"
                    data-price="{{ m.Price_per_kg_actual }}"
                  >
                    {{ m.Material_A }}
                  </option>
                  {% endfor %}
                </select>
              </td>
              {% endfor %}
            </tr>

            <tr>
              <td>Density (g/cm³)</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  step="0.00001"
                  name="density_mat_a[{{ pos.id }}]"
                  class="form-control density-input"
                  data-type="a"
                  data-pos="{{ pos.id }}"
                  readonly
                />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Volume (cm³)</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  step="0.001"
                  name="volume_mat_a[{{ pos.id }}]"
                  class="form-control volume-input"
                  data-type="a"
                  data-pos="{{ pos.id }}"
                />
              </td>
              {% endfor %}
            </tr>

            <!--Weigth / part-->
            <tr>
              <td>Weigth / part (g)</td>
              {% for pos in positions %}
              <td>
                <input
                  readonly
                  name="weight_mat_a[{{ pos.id }}]"
                  class="form-control weight-input"
                  data-type="a"
                  data-pos="{{ pos.id }}"
                />
              </td>
              {% endfor %}
            </tr>
            <!-- ================= Material B ================= -->
            <tr class="table-secondary section-sub">
              <td colspan="{{ positions|length + 1 }}">
                <strong>Material B</strong>
              </td>
            </tr>

            <!--Material B - [Foam) -->
            <tr>
              <td>Material B - [Foam]</td>
              {% for pos in positions %}
              <td>
                <select
                  name="material_b[{{ pos.id }}]"
                  class="form-control material-select"
                  data-type="b"
                  data-pos="{{ pos.id }}"
                >
                  <option value="">-- Select Material --</option>
                  {% for m in materials_b %}
                  <option
                    value="{{ m.Material_B }}"
                    data-density="{{ m.Density_kg_dm3 }}"
                    data-price="{{ m.Price_per_kg_actual }}"
                  >
                    {{ m.Material_B }}
                  </option>
                  {% endfor %}
                </select>
              </td>
              {% endfor %}
            </tr>

            <tr>
              <td>Density (g/cm³)</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  step="0.00001"
                  name="density_mat_b[{{ pos.id }}]"
                  class="form-control density-input"
                  data-type="b"
                  data-pos="{{ pos.id }}"
                  readonly
                />
              </td>
              {% endfor %}
            </tr>

            <tr>
              <td>Volume (cm³)</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  step="0.001"
                  name="volume_mat_b[{{ pos.id }}]"
                  class="form-control volume-input"
                  data-type="b"
                  data-pos="{{ pos.id }}"
                />
              </td>
              {% endfor %}
            </tr>

            <!--Weigth / part-->
            <tr>
              <td>Weight (g)</td>
              {% for pos in positions %}
              <td>
                <input
                  readonly
                  name="weight_mat_b[{{ pos.id }}]"
                  class="form-control weight-input"
                  data-type="b"
                  data-pos="{{ pos.id }}"
                />
              </td>
              {% endfor %}
            </tr>
            <!-- ================= Material C ================= -->
            <tr class="table-secondary section-sub">
              <td colspan="{{ positions|length + 1 }}">
                <strong>Material C</strong>
              </td>
            </tr>
            <tr>
              <td>Material</td>
              {% for pos in positions %}
              <td>
                <select
                  name="material_c[{{ pos.id }}]"
                  class="form-control material-select"
                  data-type="c"
                  data-pos="{{ pos.id }}"
                >
                  <option value="">-- Select Material --</option>
                  {% for m in materials_c %}
                  <option
                    value="{{ m.Material_C }}"
                    data-density="{{ m.Density_kg_dm3 }}"
                  >
                    {{ m.Material_C }}
                  </option>
                  {% endfor %}
                </select>
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Density (g/cm³)</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  step="0.00001"
                  name="density_mat_c[{{ pos.id }}]"
                  class="form-control density-input"
                  data-type="c"
                  data-pos="{{ pos.id }}"
                  readonly
                />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Volume (cm³)</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  step="0.001"
                  name="volume_mat_c[{{ pos.id }}]"
                  class="form-control volume-input"
                  data-type="c"
                  data-pos="{{ pos.id }}"
                />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Weight (g)</td>
              {% for pos in positions %}
              <td>
                <input
                  readonly
                  name="weight_mat_c[{{ pos.id }}]"
                  class="form-control weight-input"
                  data-type="c"
                  data-pos="{{ pos.id }}"
                />
              </td>
              {% endfor %}
            </tr>
            <!-- ================= Material D ================= -->
            <tr class="table-secondary section-sub">
              <td colspan="{{ positions|length + 1 }}">
                <strong>Material D</strong>
              </td>
            </tr>
            <tr>
              <td>Material</td>
              {% for pos in positions %}
              <td>
                <input name="material_d[{{ pos.id }}]" class="form-control" />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Weight (g)</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  step="0.001"
                  name="weight_mat_d[{{ pos.id }}]"
                  class="form-control weight-d"
                  data-pos="{{ pos.id }}"
                />
              </td>
              {% endfor %}
            </tr>
            <!-- ================= TOTAL Weight / Part (g)================= -->
            <tr class="table-warning text-light">
              <td><strong>Total Weight / Part (g)</strong></td>
              {% for pos in positions %}
              <td>
                <input
                  readonly
                  name="total_weight[{{ pos.id }}]"
                  class="form-control total-weight-part"
                  data-pos="{{ pos.id }}"
                />
              </td>
              {% endfor %}
            </tr>
            <!-- ================= Weight / car ================= -->
            <tr class="table-secondary">
              <td colspan="{{ positions|length + 1 }}">
                <strong>Weight / Car</strong>
              </td>
            </tr>
            <tr>
              <td>Polyamide</td>
              {% for pos in positions %}
              <td>
                <input
                  name="polyamide_weight_per_car[{{ pos.id }}]"
                  class="form-control polyamide"
                  data-pos="{{ pos.id }}"
                />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Terophon / Terocore</td>
              {% for pos in positions %}
              <td>
                <input
                  name="terophon_terocore_weight_per_car[{{ pos.id }}]"
                  class="form-control terophon"
                  data-pos="{{ pos.id }}"
                />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Steel</td>
              {% for pos in positions %}
              <td>
                <input
                  name="steel_weight_per_car[{{ pos.id }}]"
                  class="form-control steel"
                  data-pos="{{ pos.id }}"
                />
              </td>
              {% endfor %}
            </tr>
            <tr>
              <td>Others</td>
              {% for pos in positions %}
              <td>
                <input
                  name="other_mat_weight_per_car[{{ pos.id }}]"
                  class="form-control others"
                  data-pos="{{ pos.id }}"
                />
              </td>
              {% endfor %}
            </tr>
            <!-- ================= TOTAL Weight / Car (g)================= -->
            <tr class="table-warning text-opacity-75 text-light">
              <td><strong>Total Weight / Car (g)</strong></td>
              {% for pos in positions %}
              <td>
                <input
                  readonly
                  name="total_weight_per_car[{{ pos.id }}]"
                  class="form-control total-weight-car"
                  data-pos="{{ pos.id }}"
                />
              </td>
              {% endfor %}
            </tr>

            <tr class="table-primary section-main">
              <td colspan="{{ positions|length + 1 }}">
                <strong>1.3 Logistic Evaluation</strong>
              </td>
            </tr>
            <tr class="table-secondary section-sub">
              <td colspan="{{ positions|length + 1 }}">
                <strong>Packaging Concept</strong>
              </td>
            </tr>

            <!-- Type of box -->
            <tr>
              <td>Type of box</td>
              {% for pos in positions %}
              <td>
                <select
                  name="type_of_box[{{ pos.id }}]"
                  class="form-control box-select"
                  data-pos="{{ pos.id }}"
                >
                  <option value="">-- Select --</option>

                  {% for b in type_of_box %}
                  <option
                    value="{{ b.id }}"
                    data-code="{{ b.packaging_code }}"
                    data-name="{{ b.packaging_name }}"
                    data-l="{{ b.length_mm }}"
                    data-w="{{ b.width_mm }}"
                    data-h="{{ b.height_mm }}"
                    data-weight="{{ b.weight_kg }}"
                    data-volume="{{ b.volume_mm3 }}"
                  >
                    {{ b.packaging_code }} {{ b.packaging_name }}
                  </option>
                  {% endfor %}
                </select>
              </td>
              {% endfor %}
            </tr>

            <!-- Box dimensions -->
            <tr>
              <td>Box dimensions (inside) [mm]</td>
              {% for pos in positions %}
              <td>
                <input
                  class="form-control box-dim"
                  data-pos="{{ pos.id }}"
                  name="box_dimensions[{{ pos.id }}]"
                  readonly
                />
              </td>
              {% endfor %}
            </tr>

            <!-- Box weight -->
            <tr>
              <td>Box weight [kg]</td>
              {% for pos in positions %}
              <td>
                <input
                  class="form-control box-weight"
                  data-pos="{{ pos.id }}"
                  name="box_weight[{{ pos.id }}]"
                  readonly
                />
              </td>
              {% endfor %}
            </tr>

            <!-- Box volume -->
            <tr>
              <td>Box volume [l]</td>
              {% for pos in positions %}
              <td>
                <input
                  class="form-control box-volume"
                  data-pos="{{ pos.id }}"
                  name="box_volume[{{ pos.id }}]"
                  readonly
                />
              </td>
              {% endfor %}
            </tr>

            <!--Bulk Factor-->
            <tr>
              <td>Bulk factor</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control bulk-factor"
                  data-pos="{{pos.id}}"
                  name="bulk_factor[{{pos.id}}]"
                />
              </td>
              {% endfor %}
            </tr>

            <!-- Number of parts/box calculated -->
            <tr>
              <td>Number of parts/box calculated</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control parts-per-box-calc"
                  data-pos="{{pos.id}}"
                  name="parts_per_box_calc[{{pos.id}}]"
                  readonly
                />
              </td>
              {% endfor %}
            </tr>

            <!-- Number of parts/box defined -->
            <tr>
              <td>Number of parts/box defined</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control parts-per-box-defined"
                  data-pos="{{pos.id}}"
                  name="parts_per_box_defined[{{pos.id}}]"
                />
              </td>
              {% endfor %}
            </tr>

            <!-- Weight / unit red limit -->
            <tr>
              <td>Weight / unit red limit [kg]</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control weight-unit-red-limit"
                  data-pos="{{pos.id}}"
                  name="weight_unit_red_limit[{{pos.id}}]"
                  value="15"
                />
              </td>
              {% endfor %}
            </tr>
            <!-- Weight / unit (red > limit) -->
            <tr>
              <td>Weight / unit (red > limit) 15 * [kg]</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control weight-per-unit-kg"
                  data-pos="{{pos.id}}"
                  name="weight_per_unit_kg[{{pos.id}}]"
                  readonly
                />
              </td>
              {% endfor %}
            </tr>

            <tr class="table-secondary section-sub">
              <td colspan="{{ positions|length + 1 }}">
                <strong>Pallets</strong>
              </td>
            </tr>

            <!-- Pallete Description -->
            <tr>
              <td>Pallet Description [mm]</td>
              {% for pos in positions %}

              <td>
                <select
                  name="pallet_description[{{ pos.id }}]"
                  class="form-control pallet-description"
                  data-pos="{{ pos.id }}"
                >
                  <option value="">-- Select --</option>

                  {% for b in pallet_description %}
                  <option value="{{ b.id }}" data-weight="{{ b.weight_kg }}">
                    {{ b.palette_code }} {{ b.palette_name }}
                  </option>
                  {% endfor %}
                </select>
              </td>
              {%endfor%}
            </tr>

            <!-- Top description -->
            <tr>
              <td>Top Description</td>
              {% for pos in positions %}
              <td>
                <select
                  name="top_description[{{ pos.id }}]"
                  class="form-control top-description"
                  data-pos="{{ pos.id }}"
                >
                  <option value="">-- Select --</option>

                  {% for b in top_description %}
                  <option value="{{ b.id }}" data-weight="{{ b.weight_kg }}">
                    {{ b.deckel_code }} {{ b.deckel_name }}
                  </option>
                  {% endfor %}
                </select>
              </td>
              {%endfor%}
            </tr>

            <!-- boxes / pallet -->
            <tr>
              <td>Boxes / pallet [pieces]</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control boxes-per-pallet"
                  data-pos="{{pos.id}}"
                  name="boxes_per_pallet[{{pos.id}}]"
                />
              </td>
              {%endfor%}
            </tr>

            <!-- parts / pallet -->
            <tr>
              <td>Parts / pallet [parts]</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control parts-per-pallet"
                  data-pos="{{pos.id}}"
                  name="parts_per_pallet[{{pos.id}}]"
                  readonly
                />
              </td>
              {%endfor%}
            </tr>

            <!-- weight / pallet (gross) [kg] -->
            <tr>
              <td>Weight / pallet (gross) [kg]</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control pallet-weight-gross-kg"
                  data-pos="{{pos.id}}"
                  name="pallet_weight_gross_kg[{{pos.id}}]"
                  readonly
                />
              </td>
              {%endfor%}
            </tr>
            <tr class="table-secondary section-sub">
              <td colspan="{{ positions|length + 1 }}">
                <strong>Monthly</strong>
              </td>
            </tr>

            <!--parts / month-->
            <tr>
              <td>parts / month [parts]</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control parts-per-month"
                  data-pos="{{pos.id}}"
                  name="parts_per_month[{{pos.id}}]"
                  readonly
                />
              </td>
              {%endfor%}
            </tr>

            <!--Boxes / month-->
            <tr>
              <td>Boxes / month [pieces]</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control boxes-per-month"
                  data-pos="{{pos.id}}"
                  name="boxes_per_month[{{pos.id}}]"
                  readonly
                />
              </td>
              {%endfor%}
            </tr>

            <!--Pallets / month-->
            <tr>
              <td>Pallets / month [pieces]</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control pallets-per-month"
                  data-pos="{{pos.id}}"
                  name="pallets_per_month[{{pos.id}}]"
                  readonly
                />
              </td>
              {%endfor%}
            </tr>

            <tr class="table-secondary section-sub">
              <td colspan="{{ positions|length + 1 }}">
                <strong>Lot Production</strong>
              </td>
            </tr>

            <!-- Boxes requested for lot production -->
            <tr>
              <td>Boxes requested for lot production [pieces]</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control boxes-lot"
                  data-pos="{{pos.id}}"
                  name="boxes_lot[{{pos.id}}]"
                />
              </td>
              {%endfor%}
            </tr>

            <!-- Pallets requested for lot production -->
            <tr>
              <td>Pallets requested for lot production [pieces]</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control pallets-lot"
                  data-pos="{{pos.id}}"
                  name="pallets_lot[{{pos.id}}]"
                  readonly
                />
              </td>
              {% endfor %}
            </tr>

            <!--Production lot-->
            <tr>
              <td>Production lot [parts]</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control production-lot-parts"
                  data-pos="{{pos.id}}"
                  name="production_lot_parts[{{pos.id}}]"
                  readonly
                />
              </td>
              {% endfor %}
            </tr>

            <!--Number of production runs / year-->
            <tr>
              <td>Number of production runs / year</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control production-runs-per-year"
                  data-pos="{{pos.id}}"
                  name="production_runs_per_year[{{pos.id}}]"
                  readonly
                />
              </td>
              {% endfor %}
            </tr>

            <tr class="table-secondary section-sub">
              <td colspan="{{ positions|length + 1 }}">
                <strong>Orders</strong>
              </td>
            </tr>

            <!--Pallets min. order quantity-->
            <tr>
              <td>Pallets min. order quantity [pieces]</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control pallets-min-order-qty"
                  data-pos="{{pos.id}}"
                  name="pallets_min_order_qty[{{pos.id}}]"
                />
              </td>
              {% endfor %}
            </tr>

            <!--Parts min. order quantity-->
            <tr>
              <td>Parts min. order quantity [pieces]</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control parts-min-order-qty"
                  data-pos="{{pos.id}}"
                  name="parts_min_order_qty[{{pos.id}}]"
                  readonly
                />
              </td>
              {% endfor %}
            </tr>

            <!--=================== Section 2 ==========================-->
            <tr class="table-primary section-main">
              <td colspan="{{positions|length+1}}">
                <strong>2.1 Tool Layout - Material A (or 2K)</strong>
              </td>
            </tr>

            <!-- all Material A rows -->
            <tbody class="material-section" data-material="A">
              <!-- Projected Area -->
              <tr>
                <td>Projected Area [cm²]</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control projected-area"
                    data-pos="{{pos.id}}"
                    name="projected_area[A][{{pos.id}}]"
                    step="any"
                  />
                </td>
                {% endfor %}
              </tr>

              <!--Min clamping force per part (500bar) [t / pc.]-->
              <tr>
                <td>Min Clamping Force Per Part (500bar) [t / pc.]</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control min-clamping-per-part"
                    data-pos="{{pos.id}}"
                    name="min_clamping_per_part[A][{{pos.id}}]"
                    step="any"
                    readonly
                  />
                </td>
                {% endfor %}
              </tr>

              <!-- Max Dimensions L x B x H [mm]-->
              <tr>
                <td>Max Dimensions L × B × H [mm]</td>
                {% for pos in positions %}
                <td>
                  <div class="d-flex gap-1">
                    <input
                      type="number"
                      class="form-control form-control-sm"
                      name="max_dim_l[A][{{pos.id}}]"
                      placeholder="L"
                      min="0"
                    />

                    <input
                      type="number"
                      class="form-control form-control-sm"
                      name="max_dim_b[A][{{pos.id}}]"
                      placeholder="B"
                      min="0"
                    />

                    <input
                      type="number"
                      class="form-control form-control-sm"
                      name="max_dim_h[A][{{pos.id}}]"
                      placeholder="H"
                      min="0"
                    />
                  </div>
                </td>
                {% endfor %}
              </tr>

              <!-- Tool & Machine Nr -->
              <tr class="table-secondary section-sub">
                <td colspan="{{ (positions|length if positions else 1) + 1 }}">
                  <strong>Tool & Machine Nr.</strong>
                </td>
              </tr>

              <!-- Tool Codes or tool nr -->
              <tr>
                <td>Tool Codes</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="text"
                    class="form-control tool-code-mat-a"
                    data-pos="{{ pos.id }}"
                    name="tool_code[A][{{ pos.id }}]"
                    readonly
                  />
                </td>
                {% endfor %}
              </tr>

              <!-- Machine Dropdown -->
              <tr>
                <td>Machine Nr.</td>
                {% for pos in positions %}
                <td>
                  <select
                    name="tool_machine[A][{{ pos.id }}]"
                    class="form-select form-select-sm machine-select"
                    data-pos="{{ pos.id }}"
                  >
                    <option value="">-</option>
                    {% for m in machines %}
                    <option 
                      value="{{ m.id }}"
                      data-machine-rate="{{m.machine_rate_per_hour}}"
                    >
                      {{ m.machine_title }}
                    </option>
                    {% endfor %}
                  </select>
                </td>
                {% endfor %}
              </tr>

              <!-- Machine Nr. Value -->
              <tr>
                <td>Machine Nr. Value</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control machine-nr-value-a"
                    data-pos="{{ pos.id }}"
                    name="machine_nr_value[A][{{ pos.id }}]"
                  />
                </td>
                {% endfor %}
              </tr>

              <tr class="table-secondary section-sub">
                <td colspan="{{ (positions|length if positions else 1) + 1 }}">
                  <strong>2.1.1 Tooling Cost Material A</strong>
                </td>
              </tr>

              <!--Material (prorated per part nr.)-->
              <tr>
                <td>Material (prorated per part nr.)</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control material-a-prorated"
                    data-pos="{{pos.id}}"
                    name="material_a_prorated[A][{{pos.id}}]"
                  />
                </td>
                {% endfor %}
              </tr>

              <!--Manufacturing (prorated per part nr.)-->
              <tr>
                <td>Manufacturing (prorated per part nr.)</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control manufacturing-a-prorated"
                    data-pos="{{pos.id}}"
                    name="manufacturing_a_prorated[A][{{pos.id}}]"
                  />
                </td>
                {% endfor %}
              </tr>

              <!--Construction (prorated per part nr.)-->
              <tr>
                <td>Construction (prorated per part nr.)</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control construction-a-prorated"
                    data-pos="{{pos.id}}"
                    name="construction_a_prorated[A][{{pos.id}}]"
                  />
                </td>
                {% endfor %}
              </tr>

              <!--Service & Overhead (prorated per part nr.)-->
              <tr>
                <td>Service & Overhead (prorated per part nr.)</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control service-overhead-a-prorated"
                    data-pos="{{pos.id}}"
                    name="service_overhead_a_prorated[A][{{pos.id}}]"
                  />
                </td>
                {% endfor %}
              </tr>

              <!--Mould investment -->
              <tr class="table-warning">
                <td class="row-head">Mould investment (prorated per part nr.)</td>
                {% for pos in positions %}
                <td class="row-data-inputs">
                  <input
                    type="number"
                    class="form-control mould-investment-a-prorated"
                    data-pos="{{pos.id}}"
                    name="mould_investment_a_prorated[A][{{pos.id}}]"
                    readonly
                    step="any"
                  />
                </td>
                {% endfor %}
              </tr>

            </tbody>

            <!-- all Material B rows -->
             <tr class="table-primary section-main">
              <td colspan="{{positions|length+1}}">
                <strong>2.2 Tool Layout - Material B</strong>
              </td>
            </tr>

            <tbody class="material-section" data-material="B">
               <!-- Projected Area-->
              <tr>
                <td>Projected Area [cm²]</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control projected-area"
                    data-pos="{{pos.id}}"
                    name="projected_area[B][{{pos.id}}]"
                    step="any"
                  />
                </td>
                {% endfor %}
              </tr>

              <!-- min. clamping force per part (400bar) -->
              <tr>
                <td>Min Clamping Force Per Part (400 bar) [t/pc.]</td>
                {% for pos in positions%}
                <td>
                  <input
                  type="number"
                  class="form-control min-clamping-per-part"
                  data-pos="{{pos.id}}"
                  name="min_clamping_per_part[B][{{pos.id}}]"
                  step="any"
                  readonly
                />
                </td>
                {% endfor %}
              </tr>

              <!-- Max Dimensions L x B x H [mm]-->
              <tr>
                <td>Max Dimensions L × B × H [mm]</td>
                {% for pos in positions %}
                <td>
                  <div class="d-flex gap-1">
                    <input
                      type="number"
                      class="form-control form-control-sm"
                      name="max_dim_l[B][{{pos.id}}]"
                      placeholder="L"
                      min="0"
                    />

                    <input
                      type="number"
                      class="form-control form-control-sm"
                      name="max_dim_b[B][{{pos.id}}]"
                      placeholder="B"
                      min="0"
                    />

                    <input
                      type="number"
                      class="form-control form-control-sm"
                      name="max_dim_h[B][{{pos.id}}]"
                      placeholder="H"
                      min="0"
                    />
                  </div>
                </td>
                {% endfor %}
              </tr>

              <!-- Tool & Machine Nr -->
              <tr class="table-secondary section-sub">
                <td colspan="{{ (positions|length if positions else 1) + 1 }}">
                  <strong>Tool & Machine Nr.</strong>
                </td>
              </tr>

              <!-- Tool Codes -->
              <tr>
                <td>Tool Codes</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="text"
                    class="form-control tool-code-mat-b"
                    data-pos="{{ pos.id }}"
                    name="tool_code[B][{{ pos.id }}]"
                    readonly
                  />
                </td>
                {% endfor %}
              </tr>

              <!-- Machine Dropdown -->
              <tr>
                <td>Machine Nr.</td>
                {% for pos in positions %}
                <td>
                  <select
                    name="tool_machine[B][{{ pos.id }}]"
                    class="form-select form-select-sm machine-select-b"
                    data-pos="{{ pos.id }}"
                    
                  >
                    <option value="">-</option>
                    {% for m in machines %}
                    <option value="{{ m.id }}" data-machine-rate="{{m.machine_rate_per_hour}}">
                      {{ m.machine_nr }} {{ m.machine_title }}
                    </option>
                    {% endfor %}
                  </select>
                </td>
                {% endfor %}
              </tr>

              <!-- Machine Nr. Value -->
              <tr>
                <td>Machine Nr. Value</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control machine-nr-value-b"
                    data-pos="{{ pos.id }}"
                    name="machine_nr_value[B][{{ pos.id }}]"
                  />
                </td>
                {% endfor %}
              </tr>

              <tr class="table-secondary section-sub">
                <td colspan="{{ (positions|length if positions else 1) + 1 }}">
                  <strong>2.2.1 Tooling Cost Material B</strong>
                </td>
              </tr>

              <!--Material (prorated per part nr.)-->
              <tr>
                <td>Material (prorated per part nr.)</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control material-b-prorated"
                    data-pos="{{pos.id}}"
                    name="material_b_prorated[B][{{pos.id}}]"
                  />
                </td>
                {% endfor %}
              </tr>

              <!--Manufacturing (prorated per part nr.)-->
              <tr>
                <td>Manufacturing (prorated per part nr.)</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control manufacturing-b-prorated"
                    data-pos="{{pos.id}}"
                    name="manufacturing_b_prorated[B][{{pos.id}}]"
                  />
                </td>
                {% endfor %}
              </tr>

              <!--Construction (prorated per part nr.)-->
              <tr>
                <td>Construction (prorated per part nr.)</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control construction-b-prorated"
                    data-pos="{{pos.id}}"
                    name="construction_b_prorated[B][{{pos.id}}]"
                  />
                </td>
                {% endfor %}
              </tr>

              <!--Service & Overhead (prorated per part nr.)-->
              <tr>
                <td>Service & Overhead (prorated per part nr.)</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control service-overhead-b-prorated"
                    data-pos="{{pos.id}}"
                    name="service_overhead_b_prorated[B][{{pos.id}}]"
                  />
                </td>
                {% endfor %}
              </tr>

              <!--Mould investment (prorated per part nr.)-->
              <tr class="table-warning">
                <td class="row-head">Mould investment (prorated per part nr.)</td>
                {% for pos in positions %}
                <td class="row-data-inputs">
                  <input
                    type="number"
                    class="form-control mould-investment-b-prorated"
                    data-pos="{{pos.id}}"
                    name="mould_investment_b_prorated[B][{{pos.id}}]"
                    readonly
                    step="any"
                  />
                </td>
                {% endfor %}
              </tr>
            </tbody>

            <!--all Material C/D rows-->
            <tr class="table-primary section-main">
              <td colspan="{{positions|length+1}}">
                <strong>2.3 Tool Layout - Material C/D</strong>
              </td>
            </tr>

            <tbody class="material-section" data-material="C">
              <!--Comments-->
              <tr>
                <td>Comments</td>
                {% for pos in positions %}
                <td>
                  <textarea
                    name="comments[CD][{{ pos.id }}]"
                    class="form-control comments-cd"
                  ></textarea>
                </td>
                {% endfor %}
              </tr>

              <tr class="table-secondary section-sub">
                <td colspan="{{ (positions|length if positions else 1) + 1 }}">
                  <strong>2.3.1 Tooling Cost Material C</strong>
                </td>
              </tr>

              <!--Material (prorated per part nr.)-->
              <tr>
                <td>Material (prorated per part nr.)</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control material-c-prorated"
                    data-pos="{{pos.id}}"
                    name="material_c_prorated[C][{{pos.id}}]"
                  />
                </td>
                {% endfor %}
              </tr>

              <!--Manufacturing (prorated per part nr.)-->
              <tr>
                <td>Manufacturing (prorated per part nr.)</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control manufacturing-c-prorated"
                    data-pos="{{pos.id}}"
                    name="manufacturing_c_prorated[C][{{pos.id}}]"
                  />
                </td>
                {% endfor %}
              </tr>

              <!--Construction (prorated per part nr.)-->
              <tr>
                <td>Construction (prorated per part nr.)</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control construction-c-prorated"
                    data-pos="{{pos.id}}"
                    name="construction_c_prorated[C][{{pos.id}}]"
                  />
                </td>
                {% endfor %}
              </tr>

              <!--Service & Overhead (prorated per part nr.)-->
              <tr>
                <td>Service & Overhead (prorated per part nr.)</td>
                {% for pos in positions %}
                <td>
                  <input
                    type="number"
                    class="form-control service-overhead-c-prorated"
                    data-pos="{{pos.id}}"
                    name="service_overhead_c_prorated[C][{{pos.id}}]"
                  />
                </td>
                {% endfor %}
              </tr>

              <!--Mould investment (prorated per part nr.)-->
              <tr class="table-warning">
                <td class="row-head">Mould investment (prorated per part nr.)</td>
                {% for pos in positions %}
                <td class="row-data-inputs">
                  <input
                    type="number"
                    class="form-control mould-investment-c-prorated"
                    data-pos="{{pos.id}}"
                    name="mould_investment_c_prorated[C][{{pos.id}}]"
                    readonly
                    step="any"
                  />
                </td>
                {% endfor %}
              </tr>
            </tbody>
            
            <!--2.4 Total Tooling Cost-->
            <tr class="table-primary section-main">
              <td colspan="{{positions|length+1}}">
                <strong>2.4 Total Tooling Cost</strong>
              </td>
            </tr>

            <!--Total mould investment (prorated per part nr.)-->
            <tr class="table-warning">
              <td>Total Mould Investment (prorated per part nr.)</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control total-mould-investment"
                  data-pos="{{pos.id}}"
                  name="total_mould_investment[{{pos.id}}]"
                  readonly
                />
              </td>
              {% endfor %}
            </tr>

            <!--End of arm tooling or gripper cost (prorated per part nr.)-->
            <tr>
              <td>End of arm tooling or gripper cost (prorated per part nr.)</td>
              {% for pos in positions%} 
              <td>
                <input 
                type="number"
                class="form-control end-of-arm-tooling-or-gripper-cost"
                data-pos="{{pos.id}}"
                name="end_of_arm_tooling_or_gripper_cost[{{pos.id}}]"
                />
              </td>
              {% endfor %}
            </tr>
            
            <!--Total investment (prorated per part nr.)-->
            <tr class="table-warning">
              <td>Total investment (prorated per part nr.)</td>
              {% for pos in positions %}
              <td>
                <input
                  type="number"
                  class="form-control total-investment"
                  data-pos="{{pos.id}}"
                  name="total_investment[{{pos.id}}]"
                  readonly
                />
              </td>
              {% endfor %}
            </tr>
                 
            <!--===========================Section 3===============================-->
            <!-- 3.1 Component A Cost-->
             <tr class="table-primary section-main">
              <td colspan="{{positions|length+1}}">
                <strong>3.1 Component A Cost</strong>
              </td>
             </tr>

            <!-- 3.1.1 Material Cost-->
             <tr class="table-secondary section-sub">
              <td colspan="{{ positions|length + 1 }}">
                <strong>3.1.1 Material Cost</strong>
              </td>
             </tr>

             <!--Material A Cost-->
             <tr>
              <td>Material A Cost [EUR/Part]</td>
              {% for pos in positions%} 
              <td>
                <input 
                type="number"
                class="form-control _3-1-1-material-a-cost"
                data-pos="{{pos.id}}"
                name="_3_1_1_material_a_cost[{{pos.id}}]"
                readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Material A indirect cost [%]-->
             <tr>
              <td>Material A indirect cost [%]</td>
              {% for pos in positions %} 
              <td>
                <input 
                type="number"
                class="form-control _3-1-1-material-a-indirect-cost"
                data-pos="{{pos.id}}"
                name="_3_1_1_material_a_indirect_cost[{{pos.id}}]"
                />
              </td>
              {% endfor %}
             </tr>

             <!--Material A total cost-->
             <tr class="table-warning">
              <td>Material A total cost [EUR/Part]</td>
              {% for pos in positions%} 
              <td>
                <input 
                type="number"
                class="form-control _3-1-1-material-a-total-cost"
                data-pos="{{pos.id}}"
                name="_3_1_1_material_a_total_cost[{{pos.id}}]"
                readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--3.1.2 Production Cost (1K/2K/1K+1K)-->
             <tr class="table-secondary section-sub">
              <td colspan="{{positions|length+1}}">
                <strong>3.1.2 Production Cost (1K/2K/1K+1K)</strong>
              </td>
             </tr>

             <!--Machine-->
             <tr>
              <td>Machine</td>
              {% for pos in positions %}
              <td>
                <input 
                type="text"
                class="form-control _3-1-2-machine"
                data-pos="{{pos.id}}"
                name="_3_1_2_machine[{{pos.id}}]"
                readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Tool Nr.-->
             <tr>
              <td>Tool Nr.</td>
              {% for pos in positions %}
              <td>
                <input 
                type="text" 
                class="form-control _3-1-2-tool-nr" 
                data-pos="{{pos.id}}" 
                name="_3_1_2_tool_nr[{{pos.id}}]" 
                readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Number production runs per year-->
             <tr>
              <td>Number production runs per year</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-1-2-num-of-production-runs-per-year" 
                data-pos="{{pos.id}}" 
                name="_3_1_2_num_of_production_runs_per_year[{{pos.id}}]" 
                readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Number of finished parts per cycle and tool-->
             <tr>
              <td>Number of finished parts per cycle and tool</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-1-2-num-of-finished-parts-per-cycle-tool" 
                data-pos="{{pos.id}}" 
                name="_3_1_2_num_of_finished_parts_per_cycle_tool[{{pos.id}}]" 
                readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Number of finished parts per cycle and part-nr.-->
             <tr>
              <td>Number of finished parts per cycle and part-nr.</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-1-2-num-of-finished-parts-per-cycle-part-nr" 
                data-pos="{{pos.id}}" 
                name="_3_1_2_num_of_finished_parts_per_cycle_part_nr[{{pos.id}}]"
                readonly 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Start up and phase out time per production run -->
             <tr>
              <td>Start up and phase out time per production run  [h]</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-1-2-startup-phaseout-time-per-production" 
                data-pos="{{pos.id}}" 
                name="_3_1_2_startup_phaseout_time_per_production[{{pos.id}}]" 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Cycle time-->
             <tr>
              <td>Cycle time [s]</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-1-2-cycle-time" 
                data-pos="{{pos.id}}" 
                name="_3_1_2_cycle_time[{{pos.id}}]" 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Additional downtime or breakdowns-->
             <tr>
              <td>Additional downtime or breakdowns  [%]</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-1-2-downtime-breakdowns" 
                data-pos="{{pos.id}}" 
                name="_3_1_2_downtime_breakdowns[{{pos.id}}]" 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Total waste rate-->
             <tr>
              <td>Total waste rate [%]</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-1-2-total-waste-rate" 
                data-pos="{{pos.id}}" 
                name="_3_1_2_total_waste_rate[{{pos.id}}]" 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Number of parts per production run / Production lot-->
             <tr>
              <td>Number of parts per production run / Production lot</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-1-2-num-of-parts-per-production-lot" 
                data-pos="{{pos.id}}" 
                name="_3_1_2_num_of_parts_per_production_lot[{{pos.id}}]" 
                readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Duration of production run (per part-nr.)-->
             <tr>
              <td>Duration of production run (per part-nr.)  [h]</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-1-2-duration-production-run" 
                data-pos="{{pos.id}}" 
                name="_3_1_2_duration_of_production_run[{{pos.id}}]"
                readonly 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Annual machine time (per part-nr.)-->
             <tr>
              <td>Annual machine time (per part-nr.)  [h]</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-1-2-annual-machine-time" 
                data-pos="{{pos.id}}" 
                name="_3_1_2_annual_machine_time[{{pos.id}}]"
                readonly 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Shots per hour (eff.)-->
             <tr>
              <td>Shots per hour (eff.)  [1/h] </td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-1-2-shots-per-hour" 
                data-pos="{{pos.id}}" 
                name="_3_1_2_shots_per_hour[{{pos.id}}]"
                readonly 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Machine rate-->
             <tr>
              <td>Machine rate [EUR/h]</td>
              {% for pos in positions %}
              <td>
                <input 
                  type="number" 
                  class="form-control _3-1-2-machine-rate" 
                  data-pos="{{pos.id}}" 
                  name="_3_1_2_machine_rate[{{pos.id}}]"
                  readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Production Mat. A indirect cost -->
             <tr>
              <td>Production Mat. A indirect cost [%]</td>
              {% for pos in positions %}
              <td>
                <input 
                  type="number" 
                  class="form-control _3-1-2-production-mat-a-indirect-cost" 
                  data-pos="{{pos.id}}" 
                  name="_3_1_2_production_mat_a_indirect_cost[{{pos.id}}]" 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Production cost per part-->
             <tr class="table-warning">
              <td>Production cost per part [EUR]</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-1-2-production-cost-per-part" 
                data-pos="{{pos.id}}" 
                name="_3_1_2_production_cost_per_part[{{pos.id}}]" 
                readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--3.1.3 LABOUR COST (1K / 2K / 1K+1K)-->
             <tr class="table-secondary section-sub">
              <td colspan="{{positions|length+1}}">
                <strong>3.1.3 LABOUR COST (1K / 2K / 1K+1K)</strong>
              </td>
             </tr>

             <!--Personnel employment during production-->
             <tr>
              <td>Personnel employment during production [%]</td>
              {% for pos in positions %} 
              <td>
                <input 
                  type="number"
                  class="form-control _3-1-3-personnel-employment-during-production"
                  data-pos="{{pos.id}}" 
                  name="_3_1_3_personnel_employment_during_production[{{pos.id}}]"
                />
              </td>
              {% endfor %}
             </tr>

             <!--Labour cost -->
             <tr>
              <td>Labour cost</td>
              {% for pos in positions %}
              <td>
                <input 
                  type="number"
                  class="form-control _3-1-3-labour-cost" 
                  data-pos="{{pos.id}}"
                  name="_3_1_3_labour_cost[{{pos.id}}]"
                  readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Labour setup cost (100%)-->
             <tr>
              <td>Labour setup cost (100%)</td>
              {% for pos in positions %}
              <td>
                <input 
                  type="number"
                  class="form-control _3-1-3-Labour-setup-cost" 
                  data-pos="{{pos.id}}"
                  name="_3_1_3_Labour_setup_cost[{{pos.id}}]"
                  readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Labour indirect cost-->
             <tr>
              <td>Labour indirect cost [%]</td>
              {% for pos in positions %}
              <td>
                <input 
                  type="number"
                  class="form-control _3-1-3-Labour-indirect-cost" 
                  data-pos="{{pos.id}}"
                  name="_3_1_3_Labour_indirect_cost[{{pos.id}}]" 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Labour cost per part-->
             <tr class="table-warning">
              <td>Labour cost per part [EUR]</td>
              {% for pos in positions %}
              <td>
                <input 
                  type="number"
                  class="form-control _3-1-3-Labour-cost-per-part" 
                  data-pos="{{pos.id}}"
                  name="_3_1_3_Labour_cost_per_part[{{pos.id}}]"
                  readonly 
                />
              </td>
              {% endfor %}
             </tr>

            <!-- =========3.2 Component B Cost==========-->
             <tr class="table-primary section-main">
              <td colspan="{{positions|length+1}}">
                <strong>3.2 Component B Cost</strong>
              </td>
             </tr>

            <!-- 3.2.1 MATERIAL COST (1K / 2K / 1K+1K)-->
             <tr class="table-secondary section-sub">
              <td colspan="{{ positions|length + 1 }}">
                <strong>3.2.1 MATERIAL COST (1K / 2K / 1K+1K)</strong>
              </td>
             </tr>
             
             <!-- Material B cost -->
             <tr>
              <td>Material B cost [EUR/Part]</td>
              {% for pos in positions %}
              <td>  
                <input 
                  type="number"
                  class="form-control _3-2-1-material-b-cost"
                  data-pos="{{pos.id}}" 
                  name="_3_2_1_material_b_cost[{{pos.id}}]"
                  readonly 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Material B indirect cost-->
             <tr>
              <td>Material B indirect cost</td>
              {% for pos in positions %}
              <td>
                <input 
                  type="number" 
                  class="form-control _3-2-1-material-b-indirect-cost"
                  data-pos="{{pos.id}}"
                  name="_3_2_1_material_b_indirect_cost[{{pos.id}}]" 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Material B total cost-->
             <tr class="table-warning">
              <td>Material B Total Cost</td>
              {% for pos in positions %}
              <td>
                <input 
                  type="number"
                  step="any" 
                  class="form-control _3-2-1-material-b-total-cost"
                  data-pos="{{pos.id}}"
                  name="_3_2_1_material_b_total_cost[{{pos.id}}]" 
                />
              </td>
              {% endfor %}
             </tr>

             <!-- 3.2.2 PRODUCTION COST (1K)-->
             <tr class="table-secondary section-sub">
              <td colspan="{{ positions|length + 1 }}">
                <strong>3.2.2 PRODUCTION COST (1K)</strong>
              </td>
             </tr>

             <!--Machine-->
             <tr>
              <td>Machine</td>
              {% for pos in positions %}
              <td>
                <input 
                type="text"
                class="form-control _3-2-2-machine"
                data-pos="{{pos.id}}"
                name="_3_2_2_machine[{{pos.id}}]"
                readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Tool Nr.-->
             <tr>
              <td>Tool Nr.</td>
              {% for pos in positions %}
              <td>
                <input 
                type="text" 
                class="form-control _3-2-2-tool-nr" 
                data-pos="{{pos.id}}" 
                name="_3_2_2_tool_nr[{{pos.id}}]" 
                readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Number production runs per year-->
             <tr>
              <td>Number production runs per year</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-2-2-num-of-production-runs-per-year" 
                data-pos="{{pos.id}}" 
                name="_3_2_2_num_of_production_runs_per_year[{{pos.id}}]" 
                readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Number of finished parts per cycle and tool-->
             <tr>
              <td>Number of finished parts per cycle and tool</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-2-2-num-of-finished-parts-per-cycle-tool" 
                data-pos="{{pos.id}}" 
                name="_3_2_2_num_of_finished_parts_per_cycle_tool[{{pos.id}}]" 
                readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Number of finished parts per cycle and part-nr.-->
             <tr>
              <td>Number of finished parts per cycle and part-nr.</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-2-2-num-of-finished-parts-per-cycle-part-nr" 
                data-pos="{{pos.id}}" 
                name="_3_2_2_num_of_finished_parts_per_cycle_part_nr[{{pos.id}}]"
                readonly 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Start up and phase out time per production run -->
             <tr>
              <td>Start up and phase out time per production run  [h]</td>
              {% for pos in positions %}
              <td>
                <input 
                  type="number" 
                  class="form-control _3-2-2-startup-phaseout-time-per-production" 
                  data-pos="{{pos.id}}" 
                  name="_3_2_2_startup_phaseout_time_per_production[{{pos.id}}]" 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Cycle time-->
             <tr>
              <td>Cycle time [s]</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-2-2-cycle-time" 
                data-pos="{{pos.id}}" 
                name="_3_2_2_cycle_time[{{pos.id}}]" 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Additional downtime or breakdowns-->
             <tr>
              <td>Additional downtime or breakdowns  [%]</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-2-2-downtime-breakdowns" 
                data-pos="{{pos.id}}" 
                name="_3_2_2_downtime_breakdowns[{{pos.id}}]" 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Total waste rate-->
             <tr>
              <td>Total waste rate [%]</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-2-2-total-waste-rate" 
                data-pos="{{pos.id}}" 
                name="_3_2_2_total_waste_rate[{{pos.id}}]" 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Number of parts per production run / Production lot-->
             <tr>
              <td>Number of parts per production run / Production lot</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-2-2-num-of-parts-per-production-lot" 
                data-pos="{{pos.id}}" 
                name="_3_2_2_num_of_parts_per_production_lot[{{pos.id}}]" 
                readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Duration of production run (per part-nr.)-->
             <tr>
              <td>Duration of production run (per part-nr.)  [h]</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-2-2-duration-production-run" 
                data-pos="{{pos.id}}" 
                name="_3_2_2_duration_of_production_run[{{pos.id}}]"
                readonly 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Annual machine time (per part-nr.)-->
             <tr>
              <td>Annual machine time (per part-nr.)  [h]</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-2-2-annual-machine-time" 
                data-pos="{{pos.id}}" 
                name="_3_2_2_annual_machine_time[{{pos.id}}]"
                readonly 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Shots per hour (eff.)-->
             <tr>
              <td>Shots per hour (eff.)  [1/h] </td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-2-2-shots-per-hour" 
                data-pos="{{pos.id}}" 
                name="_3_2_2_shots_per_hour[{{pos.id}}]"
                readonly 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Machine rate-->
             <tr>
              <td>Machine rate [EUR/h]</td>
              {% for pos in positions %}
              <td>
                <input 
                  type="number" 
                  class="form-control _3-2-2-machine-rate" 
                  data-pos="{{pos.id}}" 
                  name="_3_2_2_machine_rate[{{pos.id}}]"
                  readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Production Mat. B indirect cost -->
             <tr>
              <td>Production Mat. B indirect cost [%]</td>
              {% for pos in positions %}
              <td>
                <input 
                  type="number" 
                  class="form-control _3-2-2-production-mat-b-indirect-cost" 
                  data-pos="{{pos.id}}" 
                  name="_3_2_2_production_mat_b_indirect_cost[{{pos.id}}]" 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Production cost per part-->
             <tr class="table-warning">
              <td>Production cost per part [EUR]</td>
              {% for pos in positions %}
              <td>
                <input 
                type="number" 
                class="form-control _3-2-2-production-cost-per-part" 
                data-pos="{{pos.id}}" 
                name="_3_2_2_production_cost_per_part[{{pos.id}}]" 
                readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!-- 3.2.3 LABOUR COST (1K)-->
             <tr class="table-secondary section-sub">
              <td colspan="{{ positions|length + 1 }}">
                <strong>3.2.3 LABOUR COST (1K)</strong>
              </td>
             </tr>

             <!--Personnel employment during production-->
             <tr>
              <td>Personnel employment during production [%]</td>
              {% for pos in positions %} 
              <td>
                <input 
                  type="number"
                  class="form-control _3-2-3-personnel-employment-during-production"
                  data-pos="{{pos.id}}" 
                  name="_3_2_3_personnel_employment_during_production[{{pos.id}}]"
                />
              </td>
              {% endfor %}
             </tr>

             <!--Labour cost -->
             <tr>
              <td>Labour cost</td>
              {% for pos in positions %}
              <td>
                <input 
                  type="number"
                  class="form-control _3-2-3-labour-cost" 
                  data-pos="{{pos.id}}"
                  name="_3_2_3_labour_cost[{{pos.id}}]"
                  readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Labour setup cost (100%)-->
             <tr>
              <td>Labour setup cost (100%)</td>
              {% for pos in positions %}
              <td>
                <input 
                  type="number"
                  class="form-control _3-2-3-Labour-setup-cost" 
                  data-pos="{{pos.id}}"
                  name="_3_2_3_Labour_setup_cost[{{pos.id}}]"
                  readonly
                />
              </td>
              {% endfor %}
             </tr>

             <!--Labour indirect cost-->
             <tr>
              <td>Labour indirect cost [%]</td>
              {% for pos in positions %}
              <td>
                <input 
                  type="number"
                  class="form-control _3-2-3-Labour-indirect-cost" 
                  data-pos="{{pos.id}}"
                  name="_3_2_3_Labour_indirect_cost[{{pos.id}}]" 
                />
              </td>
              {% endfor %}
             </tr>

             <!--Labour cost per part-->
             <tr class="table-warning">
              <td>Labour cost per part [EUR]</td>
              {% for pos in positions %}
              <td>
                <input 
                  type="number"
                  class="form-control _3-2-3-Labour-cost-per-part" 
                  data-pos="{{pos.id}}"
                  name="_3_2_3_Labour_cost_per_part[{{pos.id}}]"
                  readonly 
                />
              </td>
              {% endfor %}
             </tr>

          </tbody>
        </table>
      </div>
      <button class="btn btn-danger btn-lg mt-4">Save Section 1</button>
    </form>
  </div>
</div>
<script src="{{ url_for('static', filename='js/calculationSheet.js') }}"></script>


<!--Section 3-->
<script>

  /*==========================================================*/
  // 3.1 Component A cost 
  /*=========================*/
  const LABOUR_COST_PER_HOUR = {{ labour_cost_per_hour }};
  const LABOUR_SETUP_COST_PER_HOUR = {{ Hourly_wage_setup_price }};
  /*=========================*/

  function calculateProductionRunsPerYear_3_1_1(posId) {
    const machineRateEl = document.querySelector(
      `._3-1-2-machine-rate[data-pos="${posId}"]`
    );

    const runsPerYearEl = document.querySelector(
      `.production-runs-per-year[data-pos="${posId}"]`
    );

    const targetEl = document.querySelector(
      `._3-1-2-num-of-production-runs-per-year[data-pos="${posId}"]`
    );

    if (!machineRateEl || !runsPerYearEl || !targetEl){
      console.log(machineRateEl, runsPerYearEl, targetEl);
      return;
    }
    

    const machineRate = parseFloat(machineRateEl.value) || 0;
    const runsPerYear = parseFloat(runsPerYearEl.value) || 0;

    targetEl.value = machineRate === 0 ? 0 : runsPerYear;
  }

  function calculateNumOfPartsPerProductionLot_3_1_1(posId) {
    const machineRateEl = document.querySelector(
      `._3-1-2-machine-rate[data-pos="${posId}"]`
    );

    const productionLotEl = document.querySelector(
      `.production-lot-parts[data-pos="${posId}"]`
    );

    const targetEl = document.querySelector(
      `._3-1-2-num-of-parts-per-production-lot[data-pos="${posId}"]`
    );

    if (!machineRateEl || !productionLotEl || !targetEl) return;

    const machineRate = parseFloat(machineRateEl.value) || 0;
    const productionLot = parseFloat(productionLotEl.value) || 0;

    // Excel: =IF(G236=0,0,G105)
    targetEl.value = machineRate === 0 ? 0 : productionLot;
  }

  function calculateMachineRate_3_1_1(posId) {
    const machineSelect = document.querySelector(
      `.machine-select[data-pos="${posId}"]`
    );

    const targetEl = document.querySelector(
      `._3-1-2-machine-rate[data-pos="${posId}"]`
    );

    if (!machineSelect || !targetEl) return;

    const selectedOption = machineSelect.selectedOptions[0];
    if (!selectedOption || !selectedOption.dataset.machineRate) {
      targetEl.value = 0;
      return;
    }

    const rate = parseFloat(selectedOption.dataset.machineRate) || 0;
    targetEl.value = rate;
  }

  function calculateProductionRunDuration(posId) {
    const getVal = (cls) =>
      parseFloat(
        document.querySelector(`.${cls}[data-pos="${posId}"]`)?.value
      ) || 0;

    const machineRate = getVal("_3-1-2-machine-rate"); // G236
    if (machineRate === 0) {
      setResult(0);
      return;
    }

    const partsPerRun = getVal("_3-1-2-num-of-parts-per-production-lot"); // G232
    const cycleTimeSec = getVal("_3-1-2-cycle-time"); // G229
    const startupTime = getVal("_3-1-2-startup-phaseout-time-per-production"); // G228
    const downtimePct = getVal("_3-1-2-downtime-breakdowns") / 100; // G230
    const wastePct = getVal("_3-1-2-total-waste-rate") / 100; // G231
    const finishedTool = getVal("_3-1-2-num-of-finished-parts-per-cycle-tool"); // G226
    const finishedPart = getVal("_3-1-2-num-of-finished-parts-per-cycle-part-nr"); // G227

    if (finishedTool === 0 || finishedPart === 0) {
      setResult(0);
      return;
    }

    // (G232*G229/3600)
    const baseTimeHours = (partsPerRun * cycleTimeSec) / 3600;

    // (1 + G231 + G230)
    const lossFactor = 1 + wastePct + downtimePct;

    // ((baseTime * lossFactor) + G228)
    const totalRunTime = baseTimeHours * lossFactor + startupTime;

    // / G227 / (G226/G227)
    const durationPerPart =
      totalRunTime / finishedPart / (finishedTool / finishedPart);

    setResult(durationPerPart);

    function setResult(val) {
      const target = document.querySelector(
        `._3-1-2-duration-production-run[data-pos="${posId}"]`
      );
      if (target) target.value = val.toFixed(4);
    }
  }

  function calculateAnnualMachineTime(posId) {
    const getVal = (cls) =>
      parseFloat(
        document.querySelector(`.${cls}[data-pos="${posId}"]`)?.value
      ) || 0;

    const machineRate = getVal("_3-1-2-machine-rate"); // G236
    const partsPerYear = getVal("parts-per-year"); // G52
    const partsPerRun = getVal("_3-1-2-num-of-parts-per-production-lot"); // G232
    const durationRun = getVal("_3-1-2-duration-production-run"); // G233

    const target = document.querySelector(
      `._3-1-2-annual-machine-time[data-pos="${posId}"]`
    );
    if (!target) return;

    // Excel: IF(G236=0,0,(G52/G232*G233))
    if (machineRate === 0 || partsPerRun === 0) {
      target.value = 0;
      return;
    }

    const annualTime = (partsPerYear / partsPerRun) * durationRun;
    target.value = annualTime.toFixed(4);
  }

  function calculateShotsPerHour(posId) {
    const getVal = (cls) =>
      parseFloat(
        document.querySelector(`.${cls}[data-pos="${posId}"]`)?.value
      ) || 0;

    const partsPerRun = getVal("_3-1-2-num-of-parts-per-production-lot"); // G232
    const cycleTimeSec = getVal("_3-1-2-cycle-time"); // G229
    const downtimePct = getVal("_3-1-2-downtime-breakdowns") / 100; // G230
    const wastePct = getVal("_3-1-2-total-waste-rate") / 100; // G231
    const startupTime = getVal("_3-1-2-startup-phaseout-time-per-production"); // G228

    const target = document.querySelector(
      `._3-1-2-shots-per-hour[data-pos="${posId}"]`
    );
    if (!target) return;

    if (partsPerRun === 0 || cycleTimeSec === 0) {
      target.value = 0;
      return;
    }

    // (G232 * G229) / 3600
    const baseTimeHours = (partsPerRun * cycleTimeSec) / 3600;

    // (1 + G230 + G231)
    const lossFactor = 1 + downtimePct + wastePct;

    // denominator
    const totalTime = baseTimeHours * lossFactor + startupTime;

    if (totalTime === 0) {
      target.value = 0;
      return;
    }

    const shotsPerHour = partsPerRun / totalTime;
    target.value = shotsPerHour.toFixed(4);
  }

  function calculateProductionCostPerPart(posId) {
    const getVal = (cls) =>
      parseFloat(
        document.querySelector(`.${cls}[data-pos="${posId}"]`)?.value
      ) || 0;

    const machineRate = getVal("_3-1-2-machine-rate"); // G236
    const shotsPerHour = getVal("_3-1-2-shots-per-hour"); // G235
    const finishedPerCycle = getVal("_3-1-2-num-of-finished-parts-per-cycle-tool"); // G226
    const indirectPct =
      getVal("_3-1-2-production-mat-a-indirect-cost") / 100; // G237

    const target = document.querySelector(
      `._3-1-2-production-cost-per-part[data-pos="${posId}"]`
    );
    if (!target) return;

    // Excel: IF(G236=0,0,…)
    if (machineRate === 0 || shotsPerHour === 0 || finishedPerCycle === 0) {
      target.value = 0;
      return;
    }

    // (G236 / G235 / G226) * (1 + G237)
    const costPerPart =
      (machineRate / shotsPerHour / finishedPerCycle) *
      (1 + indirectPct);

    target.value = costPerPart.toFixed(4);
  }

  function calculateLabourCost_3_1_3(posId) {
    const getVal = (cls) =>
      parseFloat(
        document.querySelector(`.${cls}[data-pos="${posId}"]`)?.value
      ) || 0;

    const machineRate = getVal("_3-1-2-machine-rate"); // G236
    const shotsPerHour = getVal("_3-1-2-shots-per-hour"); // G235
    const finishedPerCycle = getVal("_3-1-2-num-of-finished-parts-per-cycle-tool"); // G226
    const personnelPct = getVal("_3-1-3-personnel-employment-during-production") / 100; // G241

    const target = document.querySelector(
      `._3-1-3-labour-cost[data-pos="${posId}"]`
    );

    if (!target) return;

    // Excel: IF(G236=0,0,...)
    if (
      machineRate === 0 ||
      shotsPerHour === 0 ||
      finishedPerCycle === 0 ||
      personnelPct === 0
    ) {
      target.value = 0;
      return;
    }

    // ('1. material cost'!E77 / G235 / G226 * G241)
    const labourCost =
      (LABOUR_COST_PER_HOUR / shotsPerHour / finishedPerCycle) *
      personnelPct;
    console.log("LABOUR_COST_PER_HOUR=>"+LABOUR_COST_PER_HOUR)
    target.value = labourCost.toFixed(4);
  }

  function calculateLabourSetupCost_3_1_3(posId) {
    const getVal = (cls) =>
      parseFloat(
        document.querySelector(`.${cls}[data-pos="${posId}"]`)?.value
      ) || 0;

    const machineRate = getVal("_3-1-2-machine-rate"); // G236
    const runsPerYear = getVal("_3-1-2-num-of-production-runs-per-year"); // G225
    const finishedPerCycleTool = getVal("_3-1-2-num-of-finished-parts-per-cycle-tool"); // G226
    const finishedPerCyclePartNr = getVal("_3-1-2-num-of-finished-parts-per-cycle-part-nr"); // G227
    const setupTime = getVal("_3-1-2-startup-phaseout-time-per-production"); // G228
    const partsPerYear = getVal("parts-per-year"); // G52

    const target = document.querySelector(
      `._3-1-3-Labour-setup-cost[data-pos="${posId}"]`
    );

    if (!target) return;

    // Excel: IF(G236=0,0,...)
    if (
      machineRate === 0 ||
      runsPerYear === 0 ||
      setupTime === 0 ||
      partsPerYear === 0 ||
      finishedPerCycleTool === 0 ||
      finishedPerCyclePartNr === 0
    ) {
      target.value = 0;
      return;
    }

    // Excel formula
    const labourSetupCost =
      ((LABOUR_SETUP_COST_PER_HOUR * runsPerYear * setupTime) / partsPerYear) *
      (finishedPerCyclePartNr / finishedPerCycleTool);

    target.value = labourSetupCost.toFixed(4);
  }

  /* =====================================
     Labour cost per part
     Excel: =(G242*(1+G244+G231))+(G243*(1+G244))
  ===================================== */

  function calculateLabourCostPerPart_3_1_3(posId) {
    const getVal = (cls) =>
      parseFloat(
        document.querySelector(`.${cls}[data-pos="${posId}"]`)?.value
      ) || 0;

    const labourCost = getVal("_3-1-3-labour-cost");              // G242
    const setupCost = getVal("_3-1-3-Labour-setup-cost");         // G243
    const indirectRate = getVal("_3-1-3-Labour-indirect-cost") / 100; // G244
    const wasteRate = getVal("_3-1-2-total-waste-rate") / 100;    // G231

    const target = document.querySelector(
      `._3-1-3-Labour-cost-per-part[data-pos="${posId}"]`
    );

    if (!target) return;

    const result =
      (labourCost * (1 + indirectRate + wasteRate)) +
      (setupCost * (1 + indirectRate));

      console.log("result"+ result)

    target.value = result.toFixed(4);
  }


  /* ===============================
       Tool Nr. Material A
    ================================ */
  document.addEventListener("input", function (e) {
    if (!e.target.classList.contains("tool-code-mat-a")) return;

    const posId = e.target.dataset.pos;
    if (!posId) return;

    const toolNrEl = document.querySelector(
      `._3-1-2-tool-nr[data-pos="${posId}"]`
    );

    if (toolNrEl) {
      toolNrEl.value = e.target.value;
    }
  });

  document.addEventListener("input", function (e) {
    const el = e.target;
    const posId = el.dataset.pos;
    if (!posId) return;

    /* ===============================
         Material A Cost [EUR/Part]
      =============================== */

    // Weight (g)
    const weightEl = document.querySelector(
      `.weight-input[data-type="a"][data-pos="${posId}"]`
    );
    const weight = parseFloat(weightEl?.value) || 0;

    // Material select & price
    const materialSelect = document.querySelector(
      `.material-select[data-type="a"][data-pos="${posId}"]`
    );
    const selectedOption = materialSelect?.selectedOptions[0];
    const pricePerKg = parseFloat(selectedOption?.dataset.price) || 0;

    // Waste rate (% → decimal)
    const wasteEl = document.querySelector(
      `._3-1-2-total-waste-rate[data-pos="${posId}"]`
    );
    const wasteRate = (parseFloat(wasteEl?.value) || 0) / 100;

    // Target cost field
    const costEl = document.querySelector(
      `._3-1-1-material-a-cost[data-pos="${posId}"]`
    );

    if (!costEl) return;

    // Prevent division by zero
    if (weight === 0 || pricePerKg === 0 || wasteRate >= 1) {
      costEl.value = "";
      return;
    }

    // Calculation
    const cost =
      (weight * pricePerKg) / 1000 / (1 - wasteRate);

    costEl.value = cost.toFixed(4);

    /* ===============================
       Material A total cost [EUR/Part]
       => G218 * (1 + G219)
    ================================ */

    const _3_1_1_material_a_cost = document.querySelector(
      `._3-1-1-material-a-cost[data-pos="${posId}"]`
    );

    const _3_1_1_material_a_indirect_cost = document.querySelector(
      `._3-1-1-material-a-indirect-cost[data-pos="${posId}"]`
    );

    const _3_1_1_material_a_total_cost = document.querySelector(
      `._3-1-1-material-a-total-cost[data-pos="${posId}"]`
    );

    if (
      !_3_1_1_material_a_cost ||
      !_3_1_1_material_a_indirect_cost ||
      !_3_1_1_material_a_total_cost
    ) return;

    // Convert values safely
    const costValue = parseFloat(_3_1_1_material_a_cost.value) || 0;
    const indirectPercent = parseFloat(_3_1_1_material_a_indirect_cost.value) || 0;

    // % → decimal
    const indirectRate = indirectPercent / 100;

    // Calculation
    const totalCost = costValue * (1 + indirectRate);

    // Update field
    _3_1_1_material_a_total_cost.value = totalCost.toFixed(4);

    /* ===============================
       Number production runs per year
    ================================ */
    calculateProductionRunsPerYear_3_1_1(posId);

    /* ===============================
       Number of finished parts per cycle and tool
    ================================ */
    const machine_nr_value_a = document.querySelector(
      `.machine-nr-value-a[data-pos="${posId}"]`
    );

    const targetEl = document.querySelector(
      `._3-1-2-num-of-finished-parts-per-cycle-tool[data-pos="${posId}"]`
    );

    if (!machine_nr_value_a || !targetEl) return;

    const value = parseFloat(machine_nr_value_a.value) || 0;
    targetEl.value = value > 0 ? value : 0;

    /*======================================
      Number of finished parts per cycle and part-nr.
    =========================================*/

    const _3_1_2_num_of_finished_parts_per_cycle_part_nr = document.querySelector(
      `._3-1-2-num-of-finished-parts-per-cycle-part-nr[data-pos="${posId}"]`
    );
    
    if (!machine_nr_value_a || !_3_1_2_num_of_finished_parts_per_cycle_part_nr) return;

    _3_1_2_num_of_finished_parts_per_cycle_part_nr.value = value > 0 ? value : 0;

    /*=====================================
    Machine rate
    =======================================*/
    calculateMachineRate_3_1_1(posId);
    calculateProductionCostPerPart(posId);

    /*=====================================
    Number of parts per production run / Production lot
    =======================================*/
    calculateNumOfPartsPerProductionLot_3_1_1(posId);
    calculateShotsPerHour(posId);
  });


  document.addEventListener("input", function (e) {
    const posId = e.target.dataset.pos;
    if (!posId) return;

    /*========================================
    Duration of production run (per part-nr.)
    ==========================================*/
    if (
        e.target.classList.contains("_3-1-2-cycle-time") ||
        e.target.classList.contains("_3-1-2-startup-phaseout-time-per-production") ||
        e.target.classList.contains("_3-1-2-downtime-breakdowns") ||
        e.target.classList.contains("_3-1-2-total-waste-rate")
      ) {
        calculateProductionRunDuration(posId);
        calculateAnnualMachineTime(posId); // ✅ ADD
      }

    /*=======================================
    Shots per hour (eff.)
    =========================================*/
    if (
      e.target.classList.contains("_3-1-2-cycle-time") ||
      e.target.classList.contains("_3-1-2-downtime-breakdowns") ||
      e.target.classList.contains("_3-1-2-total-waste-rate") ||
      e.target.classList.contains("_3-1-2-startup-phaseout-time-per-production")
    ) {
      calculateShotsPerHour(posId);
      calculateProductionCostPerPart(posId);
    }

    /*======================================
    Production cost per part
    ========================================*/
    if (
      e.target.classList.contains("_3-1-2-production-mat-a-indirect-cost")
    ) {
      calculateProductionCostPerPart(posId);
    }
    
  });

  document.addEventListener("change", function (e) {
    if (!e.target.classList.contains("machine-select")) return;

    const posId = e.target.dataset.pos;
    if (!posId) return;

    calculateMachineRate_3_1_1(posId);
    calculateAnnualMachineTime(posId);
  });

  /*==========Labour Cost==============*/
  
  document.addEventListener("input", function (e) {
    const posId = e.target.dataset.pos;
    if (!posId) return;
    /*====================================
    Personnel employment during production
    ======================================*/
    if (
      e.target.classList.contains("_3-1-2-machine-rate") ||
      e.target.classList.contains("_3-1-2-shots-per-hour") ||
      e.target.classList.contains("_3-1-2-num-of-finished-parts-per-cycle-tool") ||
      e.target.classList.contains("_3-1-3-personnel-employment-during-production")
    ) {
      calculateLabourCost_3_1_3(posId);
    }

    if (
      e.target.classList.contains(
        "_3-1-2-startup-phaseout-time-per-production"
      )
    ) {
      const posId = e.target.dataset.pos;
      if (!posId) return;

      calculateLabourSetupCost_3_1_3(posId);
    }

    if (
      e.target.classList.contains("_3-1-3-labour-cost") ||
      e.target.classList.contains("_3-1-3-Labour-setup-cost") ||
      e.target.classList.contains("_3-1-3-Labour-indirect-cost") ||
      e.target.classList.contains("_3-1-2-total-waste-rate")
    ) {
      calculateLabourCostPerPart_3_1_3(posId);
    }

  });

  /*======================================================*/
  /* 3.2 Component B cost*/
  /* ======================================================*/
  function calculateMaterialBCost_3_2_1(posId) {
    // Weight (g)
    const weightEl = document.querySelector(
      `.weight-input[data-type="b"][data-pos="${posId}"]`
    );
    const weight = parseFloat(weightEl?.value) || 0;

    // Material select
    const materialSelect = document.querySelector(
      `.material-select[data-type="b"][data-pos="${posId}"]`
    );
    const selectedOption = materialSelect?.selectedOptions[0];

    // Price per kg (VLOOKUP replacement)
    const pricePerKg = parseFloat(selectedOption?.dataset.price) || 0;

    // Waste rate (% → decimal)
    const wasteEl = document.querySelector(
      `._3-2-2-total-waste-rate[data-pos="${posId}"]`
    );
    const wasteRate = (parseFloat(wasteEl?.value) || 0) / 100;

    // Target field
    const targetEl = document.querySelector(
      `._3-2-1-material-b-cost[data-pos="${posId}"]`
    );

    if (!targetEl) return;

    // Prevent invalid math
    if (weight === 0 || pricePerKg === 0 || wasteRate >= 1) {
      targetEl.value = "";
      return;
    }

    // Calculation
    const cost =
      (weight * pricePerKg) / 1000 / (1 - wasteRate);

    targetEl.value = cost.toFixed(4);
  }

  function calculateMaterialBTotalCost_3_2_1(posId) {

    const materialBCostEl = document.querySelector(
      `._3-2-1-material-b-cost[data-pos="${posId}"]`
    );

    const indirectEl = document.querySelector(
      `._3-2-1-material-b-indirect-cost[data-pos="${posId}"]`
    );

    const totalEl = document.querySelector(
      `._3-2-1-material-b-total-cost[data-pos="${posId}"]`
    );

    if (!materialBCostEl || !indirectEl || !totalEl) return;

    const materialBCost = parseFloat(materialBCostEl.value) || 0;

    // ⚠️ assuming user enters %
    const indirectRate = (parseFloat(indirectEl.value) || 0) / 100;

    const total = materialBCost * (1 + indirectRate);

    totalEl.value = total.toFixed(4);
  }

  function syncMachine_B(posId) {
    console.log("Entered into function syncMachine_B()");
    const machineSelect = document.querySelector(
      `select[name="tool_machine[B][${posId}]"]`
    );
    console.log("machineSelect: "+ machineSelect);

    const outputEl = document.querySelector(
      `._3-2-2-machine[data-pos="${posId}"]`
    );

    console.log("outputEl: 0: "+ outputEl);

    if (!machineSelect || !outputEl) return;

    const selectedOption = machineSelect.selectedOptions[0];

    // Show readable machine text (nr + title)
    outputEl.value = selectedOption ? selectedOption.text.trim() : "";
  }

  function syncToolNr_B(posId) {
    const toolCodeEl = document.querySelector(
      `.tool-code-mat-b[data-pos="${posId}"]`
    );

    const outputEl = document.querySelector(
      `._3-2-2-tool-nr[data-pos="${posId}"]`
    );

    if (!toolCodeEl || !outputEl) return;

    outputEl.value = toolCodeEl.value || "";
  }

  function calculateMachineRate_3_2_2(posId) {
    const machineSelect = document.querySelector(
      `.machine-select-b[data-pos="${posId}"]`
    );

    const targetEl = document.querySelector(
      `._3-2-2-machine-rate[data-pos="${posId}"]`
    );

    if (!machineSelect || !targetEl) return;

    const selectedOption = machineSelect.selectedOptions[0];

    if (!selectedOption) {
      targetEl.value = 0;
      return;
    }

    const rate = parseFloat(selectedOption.dataset.machineRate) || 0;
    targetEl.value = rate.toFixed(2);
  }

  function calculateProductionRunsPerYear_3_2_2(posId) {

    console.log("calculateProductionRunsPerYear_3_2_2()");

    const machineRateEl = document.querySelector(
      `._3-2-2-machine-rate[data-pos="${posId}"]`
    );

    const runsPerYearEl = document.querySelector(
      `.production-runs-per-year[data-pos="${posId}"]`
    );

    const targetEl = document.querySelector(
      `._3-2-2-num-of-production-runs-per-year[data-pos="${posId}"]`
    );

    if (!machineRateEl || !runsPerYearEl || !targetEl){
      console.log(machineRateEl, runsPerYearEl, targetEl);
      return;
    }
    

    const machineRate = parseFloat(machineRateEl.value) || 0;
    const runsPerYear = parseFloat(runsPerYearEl.value) || 0;

    targetEl.value = machineRate === 0 ? 0 : runsPerYear;
  }

  function calculateNumOfPartsPerProductionLot_3_2_2(posId) {
    const machineRateEl = document.querySelector(
      `._3-2-2-machine-rate[data-pos="${posId}"]`
    );

    const productionLotEl = document.querySelector(
      `.production-lot-parts[data-pos="${posId}"]`
    );

    const targetEl = document.querySelector(
      `._3-2-2-num-of-parts-per-production-lot[data-pos="${posId}"]`
    );

    if (!machineRateEl || !productionLotEl || !targetEl) return;

    const machineRate = parseFloat(machineRateEl.value) || 0;
    const productionLot = parseFloat(productionLotEl.value) || 0;

    // Excel: =IF(G236=0,0,G105)
    targetEl.value = machineRate === 0 ? 0 : productionLot;
  }

  function calculateProductionRunDuration_3_2_2(posId) {
    const getVal = (cls) =>
      parseFloat(
        document.querySelector(`.${cls}[data-pos="${posId}"]`)?.value
      ) || 0;

    const machineRate = getVal("_3-1-2-machine-rate"); // G236
    if (machineRate === 0) {
      setResult(0);
      return;
    }

    const partsPerRun = getVal("_3-2-2-num-of-parts-per-production-lot"); // G232
    const cycleTimeSec = getVal("_3-2-2-cycle-time"); // G229
    const startupTime = getVal("_3-2-2-startup-phaseout-time-per-production"); // G228
    const downtimePct = getVal("_3-2-2-downtime-breakdowns") / 100; // G230
    const wastePct = getVal("_3-2-2-total-waste-rate") / 100; // G231
    const finishedTool = getVal("_3-2-2-num-of-finished-parts-per-cycle-tool"); // G226
    const finishedPart = getVal("_3-2-2-num-of-finished-parts-per-cycle-part-nr"); // G227

    if (finishedTool === 0 || finishedPart === 0) {
      setResult(0);
      return;
    }

    // (G232*G229/3600)
    const baseTimeHours = (partsPerRun * cycleTimeSec) / 3600;

    // (1 + G231 + G230)
    const lossFactor = 1 + wastePct + downtimePct;

    // ((baseTime * lossFactor) + G228)
    const totalRunTime = baseTimeHours * lossFactor + startupTime;

    // / G227 / (G226/G227)
    const durationPerPart =
      totalRunTime / finishedPart / (finishedTool / finishedPart);

    setResult(durationPerPart);

    function setResult(val) {
      const target = document.querySelector(
        `._3-2-2-duration-production-run[data-pos="${posId}"]`
      );
      if (target) target.value = val.toFixed(2);
    }
  }

  function calculateAnnualMachineTime_3_2_2(posId) {
    const getVal = (cls) =>
      parseFloat(
        document.querySelector(`.${cls}[data-pos="${posId}"]`)?.value
      ) || 0;

    const machineRate = getVal("_3-2-2-machine-rate"); // G268
    const partsPerYear = getVal("parts-per-year"); // G52
    const partsPerRun = getVal("_3-2-2-num-of-parts-per-production-lot"); // G264
    const durationRun = getVal("_3-2-2-duration-production-run"); // G265

    const target = document.querySelector(
      `._3-2-2-annual-machine-time[data-pos="${posId}"]`
    );
    if (!target) return;

    // Excel: =IF(G268=0,0,(G52/G264*G265))
    if (machineRate === 0 || partsPerRun === 0) {
      target.value = 0;
      return;
    }

    const annualTime = (partsPerYear / partsPerRun) * durationRun;
    target.value = annualTime.toFixed(2);
  }

  function calculateShotsPerHour_3_2_2(posId) {
    const getVal = (cls) =>
      parseFloat(
        document.querySelector(`.${cls}[data-pos="${posId}"]`)?.value
      ) || 0;

    const partsPerRun = getVal("_3-2-2-num-of-parts-per-production-lot"); // G264
    const cycleTimeSec = getVal("_3-2-2-cycle-time"); // G261
    const downtimePct = getVal("_3-2-2-downtime-breakdowns") / 100; // G262
    const wastePct = getVal("_3-2-2-total-waste-rate") / 100; // G263
    const startupTime = getVal("_3-2-2-startup-phaseout-time-per-production"); // G260

    const target = document.querySelector(
      `._3-2-2-shots-per-hour[data-pos="${posId}"]`
    );
    if (!target) return;

    if (partsPerRun === 0 || cycleTimeSec === 0) {
      target.value = 0;
      return;
    }

    // (G232 * G229) / 3600
    const baseTimeHours = (partsPerRun * cycleTimeSec) / 3600;

    // (1 + G230 + G231)
    const lossFactor = 1 + downtimePct + wastePct;

    // denominator
    const totalTime = baseTimeHours * lossFactor + startupTime;

    if (totalTime === 0) {
      target.value = 0;
      return;
    }

    const shotsPerHour = partsPerRun / totalTime;
    target.value = shotsPerHour.toFixed(2);
  }

  function calculateProductionCostPerPart_3_2_2(posId) {
    const getVal = (cls) =>
      parseFloat(
        document.querySelector(`.${cls}[data-pos="${posId}"]`)?.value
      ) || 0;

    const machineRate = getVal("_3-2-2-machine-rate"); // G268
    const shotsPerHour = getVal("_3-2-2-shots-per-hour"); // G267
    const finishedPerCycle = getVal("_3-2-2-num-of-finished-parts-per-cycle-tool"); // G258
    const indirectPct =
      getVal("_3-2-2-production-mat-b-indirect-cost") / 100; // G269 

    const target = document.querySelector(
      `._3-2-2-production-cost-per-part[data-pos="${posId}"]`
    );//270
    if (!target) return;

    // Excel: =IF(G268=0,0,(G268/G267/G258*(1+G269)))
    if (machineRate === 0 || shotsPerHour === 0 || finishedPerCycle === 0) {
      target.value = 0;
      return;
    }

    const costPerPart =
      (machineRate / shotsPerHour / finishedPerCycle) *
      (1 + indirectPct);

    target.value = costPerPart.toFixed(2);
  }  

  function calculateLabourCost_3_2_3(posId) {
    const getVal = (cls) =>
      parseFloat(
        document.querySelector(`.${cls}[data-pos="${posId}"]`)?.value
      ) || 0;

    const machineRate = getVal("_3-2-2-machine-rate"); 
    const shotsPerHour = getVal("_3-2-2-shots-per-hour"); 
    const finishedPerCycle = getVal("_3-2-2-num-of-finished-parts-per-cycle-tool"); 
    const personnelPct = getVal("_3-2-3-personnel-employment-during-production") / 100; 

    const target = document.querySelector(
      `._3-2-3-labour-cost[data-pos="${posId}"]`
    );

    if (!target) return;

    // Excel: IF(G268=0,0,...)
    if (
      machineRate === 0 ||
      shotsPerHour === 0 ||
      finishedPerCycle === 0 ||
      personnelPct === 0
    ) {
      target.value = 0;
      return;
    }

    // ('1. material cost'!$E77/G267/G258*G273)
    const labourCost =
      (LABOUR_COST_PER_HOUR / shotsPerHour / finishedPerCycle) *
      personnelPct;
    console.log("LABOUR_COST_PER_HOUR=>"+LABOUR_COST_PER_HOUR)
    target.value = labourCost.toFixed(4);
  }

  function calculateLabourSetupCost_3_2_3(posId) {
    const getVal = (cls) =>
      parseFloat(
        document.querySelector(`.${cls}[data-pos="${posId}"]`)?.value
      ) || 0;

    const machineRate = getVal("_3-2-2-machine-rate"); 
    const runsPerYear = getVal("_3-2-2-num-of-production-runs-per-year"); 
    const finishedPerCycleTool = getVal("_3-2-2-num-of-finished-parts-per-cycle-tool"); 
    const finishedPerCyclePartNr = getVal("_3-2-2-num-of-finished-parts-per-cycle-part-nr"); 
    const setupTime = getVal("_3-2-2-startup-phaseout-time-per-production"); 
    const partsPerYear = getVal("parts-per-year"); 

    const target = document.querySelector(
      `._3-2-3-Labour-setup-cost[data-pos="${posId}"]`
    );

    if (!target) return;

    // Excel: IF(G268=0,0,...)
    if (
      machineRate === 0 ||
      runsPerYear === 0 ||
      setupTime === 0 ||
      partsPerYear === 0 ||
      finishedPerCycleTool === 0 ||
      finishedPerCyclePartNr === 0
    ) {
      target.value = 0;
      return;
    }

    // Excel formula
    const labourSetupCost =
      ((LABOUR_SETUP_COST_PER_HOUR * runsPerYear * setupTime) / partsPerYear) *
      (finishedPerCyclePartNr / finishedPerCycleTool);

    target.value = labourSetupCost.toFixed(4);
  }

  function calculateLabourCostPerPart_3_2_3(posId) {
    const getVal = (cls) =>
      parseFloat(
        document.querySelector(`.${cls}[data-pos="${posId}"]`)?.value
      ) || 0;

    const labourCost = getVal("_3-2-3-labour-cost");              
    const setupCost = getVal("_3-2-3-Labour-setup-cost");         
    const indirectRate = getVal("_3-2-3-Labour-indirect-cost") / 100; 
    const wasteRate = getVal("_3-2-2-total-waste-rate") / 100;   

    const target = document.querySelector(
      `._3-2-3-Labour-cost-per-part[data-pos="${posId}"]`
    );

    if (!target) return;

    const result =
      (labourCost * (1 + indirectRate + wasteRate)) +
      (setupCost * (1 + indirectRate));

      console.log("result"+ result)

    target.value = result.toFixed(4);
  }

  document.addEventListener("change", handleMaterialBEvents);
  document.addEventListener("input", handleMaterialBEvents);

  function handleMaterialBEvents(e) {
    const posId = e.target.dataset.pos;
    if (!posId) return;

    // ONLY Component B fields
    /* ======================================================
     Material cost
     Excel: =(G65 * pricePerKg) / 1000 / (1 - G263)
    ====================================================== */
    if (
      (e.target.classList.contains("weight-input") &&
       e.target.dataset.type === "b") ||

      (e.target.classList.contains("material-select") &&
       e.target.dataset.type === "b") ||

      e.target.classList.contains("_3-2-2-total-waste-rate")
    ) {
      calculateMaterialBCost_3_2_1(posId);
      calculateMaterialBTotalCost_3_2_1(posId);
    }

    /*=======================================================
    Material B total cost
    Excel: =G250*(1+G251)
    ========================================================*/
    if(
      //(e.target.classList.contains("_3-2-1-material-b-cost")) || 
      (e.target.classList.contains("_3-2-1-material-b-indirect-cost"))
    ){
      calculateMaterialBTotalCost_3_2_1(posId);
    }

    // Tool code updated programmatically
    if (e.target.classList.contains("tool-code-mat-b")) {
      syncToolNr_B(posId);
      syncMachine_B(posId);
    }

      // Machine selection changed
    if (e.target.name?.startsWith("tool_machine[B]")) {
      syncMachine_B(posId);
      calculateMachineRate_3_2_2(posId);
    }   

    // Machine rate
    if (e.target.classList.contains("machine-select-b")) {
      calculateMachineRate_3_2_2(posId);
    }

    //Number production runs per year
    calculateProductionRunsPerYear_3_2_2(posId);
    calculateAnnualMachineTime_3_2_2(posId);

    //Number of finished parts per cycle and tool
    const machine_nr_value_b = document.querySelector(
      `.machine-nr-value-b[data-pos="${posId}"]`
    );

    const targetEl = document.querySelector(
      `._3-2-2-num-of-finished-parts-per-cycle-tool[data-pos="${posId}"]`
    );

    if (!machine_nr_value_b || !targetEl) return;

    const value = parseFloat(machine_nr_value_b.value) || 0;
    targetEl.value = value > 0 ? value : 0;

    //  Number of finished parts per cycle and part-nr.
    const _3_2_2_num_of_finished_parts_per_cycle_part_nr = document.querySelector(
      `._3-2-2-num-of-finished-parts-per-cycle-part-nr[data-pos="${posId}"]`
    );
    
    if (!machine_nr_value_b || !_3_2_2_num_of_finished_parts_per_cycle_part_nr) return;

    _3_2_2_num_of_finished_parts_per_cycle_part_nr.value = value > 0 ? value : 0;

    //Number of parts per production run / Production lot
    calculateNumOfPartsPerProductionLot_3_2_2(posId);

    //Duration of production run (per part-nr.)
    if (
      e.target.classList.contains("_3-2-2-cycle-time") ||
      e.target.classList.contains("_3-2-2-startup-phaseout-time-per-production") ||
      e.target.classList.contains("_3-2-2-downtime-breakdowns") ||
      e.target.classList.contains("_3-2-2-total-waste-rate")
    ) {
      calculateProductionRunDuration_3_2_2(posId);
      calculateAnnualMachineTime_3_2_2(posId); // ✅ ADD
    }

    /*=======================================
    Shots per hour (eff.)
    =========================================*/
    if (
      e.target.classList.contains("_3-2-2-cycle-time") ||
      e.target.classList.contains("_3-2-2-downtime-breakdowns") ||
      e.target.classList.contains("_3-2-2-total-waste-rate") ||
      e.target.classList.contains("_3-2-2-startup-phaseout-time-per-production")
    ) {
      calculateShotsPerHour_3_2_2(posId);
      calculateProductionCostPerPart_3_2_2(posId);
    }

    // Production cost per part [EUR]
    if(
      e,e.target.classList.contains("_3-2-2-production-mat-b-indirect-cost")
    ){
      calculateProductionCostPerPart_3_2_2(posId);
    }

    /*====================================
    Personnel employment during production
    ======================================*/
    if (
      e.target.classList.contains("_3-2-2-machine-rate") ||
      e.target.classList.contains("_3-2-2-shots-per-hour") ||
      e.target.classList.contains("_3-2-2-num-of-finished-parts-per-cycle-tool") ||
      e.target.classList.contains("_3-2-3-personnel-employment-during-production")
    ) {
      calculateLabourCost_3_2_3(posId);
    }
    // Labour setup cost (100%)
    if (
      e.target.classList.contains(
        "_3-2-2-startup-phaseout-time-per-production"
      )
    ) {
      const posId = e.target.dataset.pos;
      if (!posId) return;
      calculateLabourSetupCost_3_2_3(posId);
    }
    //Labour cost per part
    if (
      e.target.classList.contains("_3-2-3-labour-cost") ||
      e.target.classList.contains("_3-2-3-Labour-setup-cost") ||
      e.target.classList.contains("_3-2-3-Labour-indirect-cost") ||
      e.target.classList.contains("_3-2-2-total-waste-rate")
    ) {
      calculateLabourCostPerPart_3_2_3(posId);
    }    

  }

</script>

<script>
  document.addEventListener("change", function (e) {
    const el = e.target;

    // Only react to machine dropdown
    if (!el.classList.contains("machine-select")) return;

    const posId = el.dataset.pos;
    if (!posId) return;

    // Selected option text (e.g. "1K 180t")
    const selectedText =
      el.selectedOptions[0]?.text || "";

    // Target readonly Machine field
    const machineField = document.querySelector(
      `._3-1-2-machine[data-pos="${posId}"]`
    );

    if (machineField) {
      machineField.value = selectedText.trim();
    }
  });
</script>


<!--Section 2-->
<!--<script>
  function numberToLetters(num) {
    let letters = "";
    while (num >= 0) {
      letters = String.fromCharCode((num % 26) + 65) + letters;
      num = Math.floor(num / 26) - 1;
    }
    return letters;
  }

  function generateToolCodes() {

    // 🔑 Loop each material section independently
    document.querySelectorAll(".material-section").forEach(section => {

      const material = section.dataset.material.toLowerCase();

      const inputs = section.querySelectorAll(
        `.tool-code-mat-${material}`
      );

      inputs.forEach((input, index) => {
        input.value = numberToLetters(index);
      });

    });
  }

  // Run on page load
  document.addEventListener("DOMContentLoaded", generateToolCodes);
</script>-->
<script>
  function numberToLetters(num) {
    let letters = "";
    while (num >= 0) {
      letters = String.fromCharCode((num % 26) + 65) + letters;
      num = Math.floor(num / 26) - 1;
    }
    return letters;
  }

  function generateToolCodes() {

    document.querySelectorAll(".material-section").forEach(section => {

      const material = section.dataset.material.toLowerCase();
      if (!material) return;

      const inputs = section.querySelectorAll(
        `.tool-code-mat-${material}`
      );

      inputs.forEach((input, index) => {
        const code = numberToLetters(index);

        // ✅ set value
        input.value = code;

        // ✅ VERY IMPORTANT: trigger dependent logic
        input.dispatchEvent(
          new Event("input", { bubbles: true })
        );
      });

    });
  }

  document.addEventListener("DOMContentLoaded", generateToolCodes);
</script>


<script>
  function recalcTotalInvestment(posId) {
    const armCost =
      parseFloat(
        document.querySelector(
          `.end-of-arm-tooling-or-gripper-cost[data-pos="${posId}"]`
        )?.value
      ) || 0;

    const mouldCost =
      parseFloat(
        document.querySelector(
          `.total-mould-investment[data-pos="${posId}"]`
        )?.value
      ) || 0;

    const target = document.querySelector(
      `.total-investment[data-pos="${posId}"]`
    );

    if (target) {
      target.value = (armCost + mouldCost).toFixed(2);
    }
  }

  document.addEventListener("input", function (e) {
    const el = e.target;
    const posId = el.dataset.pos;
    if (!posId) return;

    /* ===============================
       🔥 0️⃣ End-of-arm tooling cost
       =============================== */
    if (el.classList.contains("end-of-arm-tooling-or-gripper-cost")) {
      recalcTotalInvestment(posId);
      return; // no material-section needed
    }

    /* ===============================
       Material section required below
       =============================== */
    const section = el.closest(".material-section");
    if (!section) return;

    const material = section.dataset.material; // A / B / C / ...

    /* ===============================
       1️⃣ Min clamping force
       =============================== */
    if (el.classList.contains("projected-area")) {
      const projectedArea = parseFloat(el.value) || 0;

      const pressureMap = {
        A: 0.5,
        B: 0.4,
        C: 0.45,
        D: 0.5,
      };

      const pressure = pressureMap[material] || 0.5;

      const target = section.querySelector(
        `.min-clamping-per-part[data-pos="${posId}"]`
      );

      if (target) {
        target.value = (projectedArea * pressure).toFixed(2);
      }
    }

    /* ===============================
       2️⃣ Mould investment per material
       =============================== */
    const costFields = [
      `material-${material.toLowerCase()}-prorated`,
      `manufacturing-${material.toLowerCase()}-prorated`,
      `construction-${material.toLowerCase()}-prorated`,
      `service-overhead-${material.toLowerCase()}-prorated`,
    ];

    if (costFields.some(cls => el.classList.contains(cls))) {
      const sum = costFields.reduce((total, cls) => {
        const field = section.querySelector(`.${cls}[data-pos="${posId}"]`);
        return total + (parseFloat(field?.value) || 0);
      }, 0);

      const target = section.querySelector(
        `.mould-investment-${material.toLowerCase()}-prorated[data-pos="${posId}"]`
      );

      if (target) {
        target.value = sum.toFixed(2);
      }
    }

    /* ===============================
       3️⃣ TOTAL mould investment
       =============================== */
    const getVal = (cls) =>
      parseFloat(
        document.querySelector(`.${cls}[data-pos="${posId}"]`)?.value
      ) || 0;

    const totalMould =
      getVal("mould-investment-a-prorated") +
      getVal("mould-investment-b-prorated") +
      getVal("mould-investment-c-prorated");

    const totalMouldTarget = document.querySelector(
      `.total-mould-investment[data-pos="${posId}"]`
    );

    if (totalMouldTarget) {
      totalMouldTarget.value = totalMould.toFixed(2);

      // 🔥 cascade update
      recalcTotalInvestment(posId);
    }
  });
</script>

<!--Section 1.3-->
<script>
  // ======================================================
  // PARTS / BOX (CALCULATED)
  // ======================================================
  function calculatePartsPerBox(pos) {
    const volA =
      parseFloat(
        document.querySelector(
          `.volume-input[data-type="a"][data-pos="${pos}"]`
        )?.value
      ) || 0;

    const volB =
      parseFloat(
        document.querySelector(
          `.volume-input[data-type="b"][data-pos="${pos}"]`
        )?.value
      ) || 0;

    const volC =
      parseFloat(
        document.querySelector(
          `.volume-input[data-type="c"][data-pos="${pos}"]`
        )?.value
      ) || 0;

    const boxVolume =
      parseFloat(
        document.querySelector(`.box-volume[data-pos="${pos}"]`)?.value
      ) || 0;

    const bulkFactor =
      parseFloat(
        document.querySelector(`.bulk-factor[data-pos="${pos}"]`)?.value
      ) || 0;

    const resultInput = document.querySelector(
      `.parts-per-box-calc[data-pos="${pos}"]`
    );

    if (!resultInput) return;

    // Excel: IF(G60+G64=0,0,...)
    if (volA + volB === 0 || bulkFactor === 0) {
      resultInput.value = 0;
      return;
    }

    const partsPerBox = Math.round(
      (boxVolume * 1000) / ((volA + volB + volC) * bulkFactor));

    resultInput.value = Math.floor(partsPerBox);
  }

  // ======================================================
  // WEIGHT / UNIT (red > limit) 15 * (KG)
  // Excel: ((G90/1000)*G72)+G86
  // ======================================================
  function calculateWeightPerUnit(pos) {
    const partsPerBox =
      parseFloat(
        document.querySelector(`.parts-per-box-defined[data-pos="${pos}"]`)
          ?.value
      ) || 0;

    const totalWeightPartG =
      parseFloat(
        document.querySelector(`.total-weight-part[data-pos="${pos}"]`)?.value
      ) || 0;

    const boxWeightKg =
      parseFloat(
        document.querySelector(`.box-weight[data-pos="${pos}"]`)?.value
      ) || 0;

    const resultInput = document.querySelector(
      `.weight-per-unit-kg[data-pos="${pos}"]`
    );

    if (!resultInput) return;

    const weightPerUnitKg =
      (partsPerBox * totalWeightPartG) / 1000 + boxWeightKg;

    resultInput.value = weightPerUnitKg.toFixed(2);

    // 🔴 Red warning > user limit
    const redLimit =
      parseFloat(
        document.querySelector(`.weight-unit-red-limit[data-pos="${pos}"]`)
          ?.value
      ) || 0;

    if (redLimit > 0 && weightPerUnitKg > redLimit) {
      resultInput.classList.add("bg-danger", "text-white");
    } else {
      resultInput.classList.remove("bg-danger", "text-white");
    }

    // 🔴 Red warning > 15 kg
    /*if (weightPerUnitKg > 15) {
      resultInput.classList.add("bg-danger", "text-white");
    } else {
      resultInput.classList.remove("bg-danger", "text-white");
    }*/
  }

  // ======================================================
  // PARTS / PALLET
  // Excel: =G90*IF(G95=0,1,G95)
  // ======================================================
  function calculatePartsPerPallet(pos) {
    const partsPerBox =
      parseFloat(
        document.querySelector(`.parts-per-box-defined[data-pos="${pos}"]`)
          ?.value
      ) || 0;

    let boxesPerPallet =
      parseFloat(
        document.querySelector(`.boxes-per-pallet[data-pos="${pos}"]`)?.value
      ) || 0;

    const resultInput = document.querySelector(
      `.parts-per-pallet[data-pos="${pos}"]`
    );

    if (!resultInput) return;

    // Excel IF(G95=0,1,G95)
    if (boxesPerPallet === 0) {
      boxesPerPallet = 1;
    }

    const partsPerPallet = partsPerBox * boxesPerPallet;

    resultInput.value = partsPerPallet;

    // 🔥 REQUIRED downstream trigger
    calculatePartsMinOrderQty(pos);
    calculatePalletWeightGross(pos);
  }

  // ======================================================
  // WEIGHT / PALLET (GROSS) [kg]
  // ======================================================
  function calculatePalletWeightGross(pos) {
    const totalWeightPartG =
      parseFloat(
        document.querySelector(`.total-weight-part[data-pos="${pos}"]`)?.value
      ) || 0; // G72

    const boxWeightKg =
      parseFloat(
        document.querySelector(`.box-weight[data-pos="${pos}"]`)?.value
      ) || 0; // G86

    const boxesPerPallet =
      parseFloat(
        document.querySelector(`.boxes-per-pallet[data-pos="${pos}"]`)?.value
      ) || 0; // G95

    const partsPerPallet =
      parseFloat(
        document.querySelector(`.parts-per-pallet[data-pos="${pos}"]`)?.value
      ) || 0; // G96

    // Pallet description weight (VLOOKUP G93)
    const palletSelect = document.querySelector(
      `.pallet-description[data-pos="${pos}"]`
    );
    const palletWeightKg =
      parseFloat(palletSelect?.selectedOptions[0]?.dataset.weight) || 0;

    // Top description weight (VLOOKUP G94)
    const topSelect = document.querySelector(
      `.top-description[data-pos="${pos}"]`
    );
    const topWeightKg =
      parseFloat(topSelect?.selectedOptions[0]?.dataset.weight) || 0;

    const resultInput = document.querySelector(
      `.pallet-weight-gross-kg[data-pos="${pos}"]`
    );
    if (!resultInput) return;

    // Excel IF(G95=0,1,G95)
    const boxMultiplier = boxesPerPallet === 0 ? 1 : boxesPerPallet;

    const palletWeightGross =
      (partsPerPallet * totalWeightPartG) / 1000 +
      boxWeightKg * boxMultiplier +
      palletWeightKg +
      topWeightKg;

    resultInput.value = palletWeightGross.toFixed(2);
  }

  // ======================================================
  // PARTS / MONTH
  // Excel: =G52 / 12
  // We have calculated this part from calculatePartsPerYear() and called this function from calculatePartsPerYear() function only.
  // ======================================================
  function calculatePartsPerMonth(pos) {
    const partsPerYear =
      parseFloat(
        document.querySelector(`.parts-per-year[data-pos="${pos}"]`)?.value
      ) || 0;

    const resultInput = document.querySelector(
      `.parts-per-month[data-pos="${pos}"]`
    );

    if (!resultInput) return;

    if (partsPerYear === 0) {
      resultInput.value = 0;
      return;
    }

    resultInput.value = Math.round(partsPerYear / 12);
  }

  // ======================================================
  // BOXES / MONTH
  // Excel: =IF(G90=0,0,G99/G90)
  // ======================================================
  function calculateBoxesPerMonth(pos) {
    const partsPerBox =
      parseFloat(
        document.querySelector(`.parts-per-box-defined[data-pos="${pos}"]`)
          ?.value
      ) || 0;

    const partsPerMonth =
      parseFloat(
        document.querySelector(`.parts-per-month[data-pos="${pos}"]`)?.value
      ) || 0;

    const resultInput = document.querySelector(
      `.boxes-per-month[data-pos="${pos}"]`
    );

    if (!resultInput) return;

    if (partsPerBox === 0) {
      resultInput.value = 0;
      return;
    }

    resultInput.value = Math.ceil(partsPerMonth / partsPerBox);
  }

  // ======================================================
  // PALLETS / MONTH
  // Excel: =IF(G96=0,0,G99/G96)
  // ======================================================
  function calculatePalletsPerMonth(pos) {
    const partsPerPallet =
      parseFloat(
        document.querySelector(`.parts-per-pallet[data-pos="${pos}"]`)?.value
      ) || 0;

    const partsPerMonth =
      parseFloat(
        document.querySelector(`.parts-per-month[data-pos="${pos}"]`)?.value
      ) || 0;

    const resultInput = document.querySelector(
      `.pallets-per-month[data-pos="${pos}"]`
    );

    if (!resultInput) return;

    // Excel: IF(G96=0,0,G99/G96)
    if (partsPerPallet === 0) {
      resultInput.value = 0;
      return;
    }

    const pallets = partsPerMonth / partsPerPallet;
    resultInput.value = pallets.toFixed(2); // or 4 if needed
  }


  // ======================================================
  // PALLETS REQUESTED FOR LOT PRODUCTION
  // Excel: =ROUND(G103/IF(G95=0,1,G95),2)
  // ======================================================
  function calculatePalletsLot(pos) {
    const boxesLot =
      parseFloat(
        document.querySelector(`.boxes-lot[data-pos="${pos}"]`)?.value
      ) || 0;

    const boxesPerPallet =
      parseFloat(
        document.querySelector(`.boxes-per-pallet[data-pos="${pos}"]`)?.value
      ) || 0;

    const resultInput = document.querySelector(
      `.pallets-lot[data-pos="${pos}"]`
    );

    if (!resultInput) return;

    const divisor = boxesPerPallet === 0 ? 1 : boxesPerPallet;

    resultInput.value = (boxesLot / divisor).toFixed(2);
  }

  // ======================================================
  // PRODUCTION LOT (PARTS)
  // Excel: =G103 * G90
  // ======================================================
  function calculateProductionLot(pos) {
    const boxesLot =
      parseFloat(
        document.querySelector(`.boxes-lot[data-pos="${pos}"]`)?.value
      ) || 0;

    const partsPerBox =
      parseFloat(
        document.querySelector(`.parts-per-box-defined[data-pos="${pos}"]`)
          ?.value
      ) || 0;

    const resultInput = document.querySelector(
      `.production-lot-parts[data-pos="${pos}"]`
    );

    if (!resultInput) return;

    resultInput.value = boxesLot * partsPerBox;

    // 🔥 REQUIRED
    calculateProductionRunsPerYear(pos);

    // 🔥 CHAINED like Excel
    calculateNumOfPartsPerProductionLot_3_1_1(pos);
    calculateNumOfPartsPerProductionLot_3_2_2(pos);
    //calculateNumOfPartsPerProductionLot(pos);
  }

  // ======================================================
  // NUMBER OF PRODUCTION RUNS / YEAR
  // Excel: =IF(G90=0,0,ROUNDUP(G52/G105,0))
  // ======================================================
  function calculateProductionRunsPerYear(pos) {
    const partsPerBox =
      parseFloat(
        document.querySelector(`.parts-per-box-defined[data-pos="${pos}"]`)
          ?.value
      ) || 0;

    const partsPerYear =
      parseFloat(
        document.querySelector(`.parts-per-year[data-pos="${pos}"]`)?.value
      ) || 0;

    const productionLot =
      parseFloat(
        document.querySelector(`.production-lot-parts[data-pos="${pos}"]`)
          ?.value
      ) || 0;

    const resultInput = document.querySelector(
      `.production-runs-per-year[data-pos="${pos}"]`
    );

    if (!resultInput) return;

    // Excel IF(G90=0,0,...)
    if (partsPerBox === 0 || productionLot === 0) {
      resultInput.value = 0;
      return;
    }

    resultInput.value = Math.ceil(partsPerYear / productionLot);
    // 🔥 Force dependent recalculation
    calculateProductionRunsPerYear_3_1_1(pos);
    calculateProductionRunsPerYear_3_2_2(pos);
  }

  // ======================================================
  // PARTS MIN. ORDER QUANTITY
  // Excel: =G96 * G108
  // ======================================================
  function calculatePartsMinOrderQty(pos) {
    const partsPerPallet =
      parseFloat(
        document.querySelector(`.parts-per-pallet[data-pos="${pos}"]`)?.value
      ) || 0;

    const palletsMinOrderQty =
      parseFloat(
        document.querySelector(`.pallets-min-order-qty[data-pos="${pos}"]`)
          ?.value
      ) || 0;

    const resultInput = document.querySelector(
      `.parts-min-order-qty[data-pos="${pos}"]`
    );

    if (!resultInput) return;

    if (partsPerPallet === 0 || palletsMinOrderQty === 0) {
      resultInput.value = 0;
      return;
    }

    resultInput.value = partsPerPallet * palletsMinOrderQty;
  }

  // ======================================================
  // CHANGE EVENTS (dropdowns, selects)
  // ======================================================
  document.addEventListener("change", function (e) {
    const pos = e.target.dataset.pos;
    if (!pos) return;

    // -------------------------------
    // BOX SELECT → AUTO-FILL
    // -------------------------------
    if (e.target.classList.contains("box-select")) {
      const opt = e.target.selectedOptions[0];
      if (!opt) return;

      const l = opt.dataset.l || 0;
      const w = opt.dataset.w || 0;
      const h = opt.dataset.h || 0;
      const weight = opt.dataset.weight || 0;
      const volume = opt.dataset.volume || 0;

      document.querySelector(
        `.box-dim[data-pos="${pos}"]`
      ).value = `${l} x ${w} x ${h}`;

      document.querySelector(`.box-weight[data-pos="${pos}"]`).value =
        Number(weight).toFixed(2);

      document.querySelector(`.box-volume[data-pos="${pos}"]`).value =
        Number(volume).toFixed(2);

      calculatePartsPerBox(pos);
      calculateWeightPerUnit(pos);
      calculatePalletWeightGross(pos);
    }

    // -------------------------------
    // PALLET / TOP DESCRIPTION
    // -------------------------------
    if (
      e.target.classList.contains("pallet-description") ||
      e.target.classList.contains("top-description")
    ) {
      calculatePalletWeightGross(pos);
    }

    // -------------------------------
    // BOXES / MONTH
    // -------------------------------
    if (
      e.target.classList.contains("parts-per-month") ||
      e.target.classList.contains("parts-per-box-defined")
    ) {
      calculateBoxesPerMonth(pos);
    }
  });

  // ======================================================
  // INPUT EVENTS (numbers, typing)
  // ======================================================
  document.addEventListener("input", function (e) {
    const pos = e.target.dataset.pos;
    if (!pos) return;

    // -------------------------------
    // PARTS / BOX (calculated)
    // -------------------------------
    if (
      e.target.classList.contains("volume-input") ||
      e.target.classList.contains("bulk-factor")
    ) {
      calculatePartsPerBox(pos);
    }

    // -------------------------------
    // WEIGHT / UNIT
    // -------------------------------
    if (
      e.target.classList.contains("parts-per-box-defined") ||
      e.target.classList.contains("total-weight-part") ||
      e.target.classList.contains("box-weight") ||
      e.target.classList.contains("weight-unit-red-limit")
    ) {
      calculateWeightPerUnit(pos);
    }

    // -------------------------------
    // PARTS / PALLET
    // -------------------------------
    if (
      e.target.classList.contains("parts-per-box-defined") ||
      e.target.classList.contains("boxes-per-pallet")
    ) {
      calculatePartsPerPallet(pos);
      calculatePalletsPerMonth(pos);
    }

    // -------------------------------
    // WEIGHT / PALLET (GROSS)
    // -------------------------------
    if (
      e.target.classList.contains("total-weight-part") ||
      e.target.classList.contains("box-weight") ||
      e.target.classList.contains("boxes-per-pallet") ||
      e.target.classList.contains("parts-per-pallet")
    ) {
      calculatePalletWeightGross(pos);
    }

    // -------------------------------
    // G90 → parts / box
    // -------------------------------
    if (e.target.classList.contains("parts-per-box-defined")) {
      calculateBoxesPerMonth(pos); // direct dependency
      calculatePartsPerPallet(pos); // 👈 IMPORTANT
      calculatePalletsPerMonth(pos); // indirect dependency
    }
    // -------------------------------
    // G96 → parts / pallet (explicit user change)
    // -------------------------------
    if (e.target.classList.contains("parts-per-pallet")) {
      calculatePalletsPerMonth(pos);
    }
    // -------------------------------
    // G99 → parts / month
    // -------------------------------
    if (e.target.classList.contains("parts-per-month")) {
      calculateBoxesPerMonth(pos);
      calculatePalletsPerMonth(pos);
    }

    // -------------------------------
    // PALLETS REQUESTED FOR LOT PRODUCTION
    // -------------------------------

    if (
      e.target.classList.contains("boxes-lot") ||
      e.target.classList.contains("boxes-per-pallet")
    ) {
      calculatePalletsLot(pos);
    }

    // -------------------------------
    // PRODUCTION LOT (PARTS)
    // -------------------------------

    if (
      e.target.classList.contains("boxes-lot") ||
      e.target.classList.contains("parts-per-box-defined")
    ) {
      calculateProductionLot(pos);
    }

    // -------------------------------
    // PRODUCTION RUNS PER YEAR
    // -------------------------------
    if (e.target.classList.contains("parts-per-box-defined")) {
      calculateProductionRunsPerYear(pos);
    }

    // -------------------------------
    // PARTS MIN. ORDER QUANTITY
    // -------------------------------
    if (e.target.classList.contains("pallets-min-order-qty")) {
      calculatePartsMinOrderQty(pos);
    }
  });
</script>

<!--Section 1.2-->
<script>
  /* =========================
     Section 1.2: Material dropdown → density
     ========================= */
  document.addEventListener("change", function (e) {
    const select = e.target;
    if (!select.classList.contains("material-select")) return;

    const pos = select.dataset.pos;
    const type = select.dataset.type;
    const density = select.selectedOptions[0]?.dataset.density || 0;

    const densityInput = document.querySelector(
      `.density-input[data-type="${type}"][data-pos="${pos}"]`
    );

    if (densityInput) {
      densityInput.value = Number(density).toFixed(5);
      recalcAll(pos); // IMPORTANT
    }
  });

  /* =========================
     Helpers
     ========================= */
  function num(el) {
    return el ? Number(el.value || 0) : 0;
  }

  function getValue(type, field, pos) {
    return num(
      document.querySelector(
        `.${field}[data-type="${type}"][data-pos="${pos}"]`
      )
    );
  }

  function setValue(type, field, pos, value) {
    const el = document.querySelector(
      `.${field}[data-type="${type}"][data-pos="${pos}"]`
    );
    if (el) el.value = value.toFixed(3);
  }

  /* =========================
     Section 1.2: Weight / PART
     ========================= */
  function recalcWeightPerPart(pos) {
    const wa =
      getValue("a", "density-input", pos) * getValue("a", "volume-input", pos);
    const wb =
      getValue("b", "density-input", pos) * getValue("b", "volume-input", pos);
    const wc =
      getValue("c", "density-input", pos) * getValue("c", "volume-input", pos);
    const wd =
      getValue("d", "density-input", pos) * getValue("d", "volume-input", pos);

    setValue("a", "weight-input", pos, wa);
    setValue("b", "weight-input", pos, wb);
    setValue("c", "weight-input", pos, wc);
    setValue("d", "weight-input", pos, wd);

    const total = wa + wb + wc + wd;
    //const total = Math.round( wa + wb + wc + wd);
    //const total = ROUNDUP( wa + wb + wc + wd);
    const totalEl = document.querySelector(
      `.total-weight-part[data-pos="${pos}"]`
    );
    if (totalEl) totalEl.value = total.toFixed(3);
  }

  /* =========================
     Weight / CAR
     ========================= */
  function recalcWeightPerCar(pos) {
    const parts = num(
      document.querySelector(`.parts-per-car[data-pos="${pos}"]`)
    );

    const wa = num(
      document.querySelector(`.weight-input[data-type="a"][data-pos="${pos}"]`)
    );
    const wb = num(
      document.querySelector(`.weight-input[data-type="b"][data-pos="${pos}"]`)
    );
    const wc = num(
      document.querySelector(`.weight-input[data-type="c"][data-pos="${pos}"]`)
    );
    const wd = num(
      document.querySelector(`.weight-input[data-type="d"][data-pos="${pos}"]`)
    );

    const polyamide = wa * parts;
    const terophon = wb * parts;
    const steel = wc * parts;
    const others = wd * parts;

    const set = (cls, val) => {
      const el = document.querySelector(`.${cls}[data-pos="${pos}"]`);
      if (el) el.value = val.toFixed(3);
    };

    set("polyamide", polyamide);
    set("terophon", terophon);
    set("steel", steel);
    set("others", others);

    const total = polyamide + terophon + steel + others;
    const totalEl = document.querySelector(
      `.total-weight-car[data-pos="${pos}"]`
    );
    if (totalEl) totalEl.value = total.toFixed(3);
  }

  /* =========================
     Master recalculation
     ========================= */
  function recalcAll(pos) {
    recalcWeightPerPart(pos);
    recalcWeightPerCar(pos);
    // 🔥 ADD THIS
  calculateMaterialBCost_3_2_1(pos);
  }

  /* =========================
     ONE global input handler
     ========================= */
  document.addEventListener("input", function (e) {
    const pos = e.target.dataset.pos;
    if (!pos) return;
    recalcAll(pos);
  });
</script>

<!--Section 1.1-->
<!-- ===========pos_plant_derivatives ============== -->
<script>
  function calculatePlantTotals() {
    const totals = {};

    // Initialize totals
    document.querySelectorAll(".plant-total").forEach((total) => {
      totals[total.dataset.pos] = 0;
    });

    // Sum derivatives
    document.querySelectorAll(".plant-input").forEach((input) => {
      const pos = input.dataset.pos;
      const checkbox = input.previousElementSibling;

      if (checkbox && checkbox.checked) {
        totals[pos] += Number(input.value || 0);
      }
    });

    // Update totals + Parts/Year
    Object.keys(totals).forEach((pos) => {
      const totalCarsInput = document.getElementById(`plant_total_${pos}`);
      if (totalCarsInput) {
        totalCarsInput.value = totals[pos];
      }

      calculatePartsPerYear(pos);
      calculateAnnualMachineTime(pos);
      calculateAnnualMachineTime_3_2_2(pos);
    });
  }

  function calculatePartsPerYear(pos) {
    const partsPerCarInput = document.querySelector(
      `.parts-per-car[data-pos="${pos}"]`
    );

    const totalCarsInput = document.getElementById(`plant_total_${pos}`);

    const partsPerYearInput = document.querySelector(
      `.parts-per-year[data-pos="${pos}"]`
    );

    if (!partsPerCarInput || !totalCarsInput || !partsPerYearInput) return;

    const partsPerCar = Number(partsPerCarInput.value || 0);
    const totalCars = Number(totalCarsInput.value || 0);

    partsPerYearInput.value = partsPerCar * totalCars;

    // 🔥 CRITICAL: trigger dependent calculation (Section 1.3)
    calculatePartsPerMonth(pos);
    calculateProductionRunsPerYear(pos);
  }

  // Recalculate when Parts / Car changes
  document.addEventListener("input", function (e) {
    if (e.target.classList.contains("parts-per-car")) {
      calculatePartsPerYear(e.target.dataset.pos);
    }
  });

  // Initial calculation
  document.addEventListener("DOMContentLoaded", calculatePlantTotals);
</script>
<!-- ===========pos_plant_derivatives ============== -->

<!-- Toggle Script -->
<script>
  function toggleQuotationForm() {
    const card = document.getElementById("quotationFormCard");
    card.classList.toggle("d-none");
  }
  function togglePartSpecificationForm() {
    const card = document.getElementById("partSpecificationFormCard");
    card.classList.toggle("d-none");
  }
</script>

<style>
  .table tr.table-dark td,
  .table tr.table-secondary td {
    font-size: 0.95rem;
    letter-spacing: 0.5px;
  }
  /* Scroll container */
  .table-scroll {
    max-height: 75vh;
    overflow-y: auto;
    overflow-x: auto;
  }

  /* Sticky table header */
  .table-scroll thead th {
    position: sticky;
    top: 0;
    z-index: 5;
    background: #f8f9fa; /* same as table-light */
  }

  /* Optional: Sticky section headers inside tbody */
  .table-scroll tbody tr.table-dark td,
  .table-scroll tbody tr.table-secondary td {
    position: sticky;
    top: 42px; /* height of thead */
    z-index: 4;
  }
  .table-primary td {
    background-color: #d1ecf1 !important;
    font-size: 1rem;
  }

  .table-secondary td {
    background-color: #e9ecef !important;
    font-weight: 600;
  }

  .table tbody tr td:first-child {
    font-weight: 500;
  }
  /* Main section header (1.1) */
  .section-main td {
    position: sticky;
    top: 42px; /* height of thead */
    z-index: 90;
    background: #cfe2ff;
  }

  /* Sub-section headers */
  .section-sub td {
    position: sticky;
    top: 82px; /* thead + main section */
    z-index: 80;
    background: #e9ecef;
  }
  td {
    min-width: 200px;
  }
</style>
{% endblock %}
